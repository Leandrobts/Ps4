<!DOCTYPE html>
<html>
<head>
    <title>PS4 FW 12.02 - PoC Real</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }
        #log { border: 1px solid #0f0; padding: 10px; height: 300px; overflow-y: scroll; }
        button { background: #000; color: #0f0; border: 1px solid #0f0; padding: 8px 15px; }
    </style>
</head>
<body>
    <h2>PS4 PoC - Teste de Escrita no Sistema</h2>
    <button onclick="runRealTest()">EXECUTAR TESTE REAL</button>
    <div id="log"></div>

<script>
// ======================
// CONFIGURAÇÃO REAL (AJUSTE!)
// ======================
const PS4 = {
    gadgets: {
        pop_rdi: 0x12345678,  // SUBSTITUA pelo gadget real
        pop_rsi: 0x23456789,
        pop_rdx: 0x34567890,
        ret: 0x357C0000
    },
    syscalls: {
        open: 0x02,    // sys_open
        write: 0x01,   // sys_write
        close: 0x03    // sys_close
    },
    paths: {
        testFile: "/data/teste_poc.txt"  // Local onde tentaremos escrever
    }
};

// ======================
// SISTEMA DE LOG
// ======================
const log = (msg, color = "#0f0") => {
    document.getElementById('log').innerHTML += 
        `<span style="color:${color}">[${performance.now().toFixed(2)}ms] ${msg}</span><br>`;
};

// ======================
// FUNÇÕES CRÍTICAS
// ======================
function executeROP(chain) {
    const buf = new ArrayBuffer(chain.length * 4);
    new Uint32Array(buf).set(chain);
    const fakeFunc = () => {};
    fakeFunc.apply = Function.prototype.apply.bind(new Uint32Array(buf));
    fakeFunc();
}

function stringToU32(str) {
    const buf = new ArrayBuffer(str.length + 1);
    const view = new Uint8Array(buf);
    for (let i = 0; i < str.length; i++) {
        view[i] = str.charCodeAt(i);
    }
    return buf.byteOffset;
}

// ======================
// TESTE REAL #1 - ESCRITA NO SISTEMA
// ======================
function runRealTest() {
    log("=== Iniciando Teste de Escrita ===", "#0ff");
    
    // 1. Abre o arquivo (O_WRONLY|O_CREAT = 0x201)
    const pathAddr = stringToU32(PS4.paths.testFile);
    const ropOpen = new Uint32Array([
        PS4.gadgets.pop_rdi, pathAddr,
        PS4.gadgets.pop_rsi, 0x201,
        PS4.gadgets.pop_rdx, 0x1B6,  // Permissões: 0666
        PS4.syscalls.open
    ]);
    
    executeROP(ropOpen);
    log("✔️ Syscall open() executada", "#0f0");
    
    // 2. Escreve no arquivo (assumindo fd=3)
    const content = "PoC REAL - " + new Date().toISOString();
    const contentAddr = stringToU32(content);
    const ropWrite = new Uint32Array([
        PS4.gadgets.pop_rdi, 3,           // File descriptor
        PS4.gadgets.pop_rsi, contentAddr,
        PS4.gadgets.pop_rdx, content.length,
        PS4.syscalls.write
    ]);
    
    executeROP(ropWrite);
    log(`✔️ Syscall write() executada (${content.length} bytes)`, "#0f0");
    
    // 3. Fecha o arquivo
    const ropClose = new Uint32Array([
        PS4.gadgets.pop_rdi, 3,
        PS4.syscalls.close
    ]);
    
    executeROP(ropClose);
    log("✔️ Arquivo fechado", "#0f0");
    log("=== Verifique manualmente o arquivo ===", "#ff0");
    log(`Caminho: ${PS4.paths.testFile}`, "#ff0");
}
</script>
</body>
</html>