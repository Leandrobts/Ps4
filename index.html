<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit Exploit - Testes 1, 2 e 4 Isolados (IIFE)</title>
</head>

<body>
    <h1>Testes 1, 2 e 4 Isolados (IIFE)</h1>
    <div id="output"></div>

    <h2>Teste 1: Investigar a Memória da GPU</h2>
    <canvas id="gpuCanvas1" width="64" height="1" style="border: 1px solid black; margin-bottom: 10px;"></canvas>
    <pre id="gpuResult1"></pre>
    <button id="gpuButton1">Teste GPU 1: Padrão Linear Horizontal</button>

    <canvas id="gpuCanvas2" width="1" height="64" style="border: 1px solid black; margin-bottom: 10px;"></canvas>
    <pre id="gpuResult2"></pre>
    <button id="gpuButton2">Teste GPU 2: Padrão Linear Vertical</button>

    <canvas id="gpuCanvas3" width="8" height="8" style="border: 1px solid black; margin-bottom: 10px;"></canvas>
    <pre id="gpuResult3"></pre>
    <button id="gpuButton3">Teste GPU 3: Padrão de Xadrez</button>

    <canvas id="gpuCanvas4" width="16" height="16" style="border: 1px solid black; margin-bottom: 10px;"></canvas>
    <pre id="gpuResult4"></pre>
    <button id="gpuButton4">Teste GPU 4: Leitura Amostrada</button>

    <hr>

    <h2>Teste 2: Exploração da API Canvas 2D (Leitura/Escrita Precisa e Robustos)</h2>
    <canvas id="rwCanvas1" width="2" height="1" style="border: 1px solid black; cursor: pointer;"></canvas>
    <pre id="rwResult1"></pre>
    <canvas id="rwCanvas2" width="1" height="2" style="border: 1px solid black; cursor: pointer; margin-top: 5px;"></canvas>
    <pre id="rwResult2"></pre>
    <button id="readCanvasButton">Clique para ler área maior do canvas</button>
    <pre id="readCanvasResult"></pre>
    <div id="patternCanvasContainer">
        <canvas id="patternCanvas" width="2" height="1" style="border: 1px solid black; cursor: pointer;"></canvas>
        <pre id="patternCanvasResult"></pre>
    </div>

    <hr>

    <h2>Teste 4: Analisar a Disposição da Memória</h2>
    <pre id="memoryLayoutResult1"></pre>
    <button id="memoryLayoutButton1">Teste Layout 1: Alocar e Ler (Sequencial)</button>

    <pre id="memoryLayoutResult2"></pre>
    <button id="memoryLayoutButton2">Teste Layout 2: Alocar e Ler (Espaçado)</button>

    <pre id="memoryLayoutResult3"></pre>
    <button id="memoryLayoutButton3">Teste Layout 3: Inspeção de Buffers Globais</button>

    <pre id="memoryLayoutResult4"></pre>
    <button id="memoryLayoutButton4">Teste Layout 4: Tentativa de Overlap</button>

    <script>
        const log = (message, type = 'info') => {
            const outputDiv = document.getElementById('output');
            if (outputDiv) {
                outputDiv.innerHTML += `<span style="color: <span class="math-inline">\{type \=\=\= 'error' ? 'red' \: type \=\=\= 'warning' ? 'orange' \: 'blue'\};"\></span>{new Date().toLocaleTimeString()} - ${message}\n</span>`;
            } else {
                console.error('Elemento #output não encontrado!');
            }
        };

        function prepareData() {
            log("Função prepareData() iniciada e concluída (para consistência).", 'info');
            let bufferSize = 64;
            let buffer = new ArrayBuffer(bufferSize);
            let view = new Uint8Array(buffer);
            return {
                buffer,
                view,
                bufferSize
            };
        }

        // --- Teste 1: Investigar a Memória da GPU ---
        (function() {
            const testName = "Teste 1: Investigar a Memória da GPU";
            log(`\n--- ${testName} ---`, 'critical');

            function testGPUMemory1() {
                prepareData();
                const canvas = document.getElementById('gpuCanvas1');
                const ctx = canvas.getContext('2d');
                const resultElement = document.getElementById('gpuResult1');
                if (ctx) {
                    for (let i = 0; i < canvas.width; i++) {
                        ctx.fillStyle = `rgba(${i * 4 % 256}, ${(i * 4 + 85) % 256}, ${(i * 4 + 170) % 256}, 255)`;
                        ctx.fillRect(i, 0, 1, 1);
                    }
                    const imageData = ctx.getImageData(0, 0, canvas.width, 1).data;
                    resultElement.textContent = 'Padrão Horizontal RGBA: ' + Array.from(imageData).join(',');
                } else {
                    resultElement.textContent = 'Erro ao obter contexto GPU 1.';
                }
            }

            function testGPUMemory2() {
                prepareData();
                const canvas = document.getElementById('gpuCanvas2');
                const ctx = canvas.getContext('2d');
                const resultElement = document.getElementById('gpuResult2');
                if (ctx) {
                    for (let i = 0; i < canvas.height; i++) {
                        ctx.fillStyle = `rgba(${(i * 4 + 170) % 256}, ${i * 4 % 256}, ${(i * 4 + 85) % 256}, 255)`;
                        ctx.fillRect(0, i, 1, 1);
                    }
                    const imageData = ctx.getImageData(0, 0, 1, canvas.height).data;
                    resultElement.textContent = 'Padrão Vertical RGBA: ' + Array.from(imageData).join(',');
                } else {
                    resultElement.textContent = 'Erro ao obter contexto GPU 2.';
                }
            }

            function testGPUMemory3() {
                prepareData();
                const canvas = document.getElementById('gpuCanvas3');
                const ctx = canvas.getContext('2d');
                const resultElement = document.getElementById('gpuResult3');
                if (ctx) {
                    for (let y = 0; y < canvas.height; y++) {
                        for (let x = 0; x < canvas.width; x++) {
                            ctx.fillStyle = (x % 2 === y % 2) ? 'black' : 'white';
                            ctx.fillRect(x, y, 1, 1);
                        }
                    }
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                    resultElement.textContent = 'Padrão Xadrez RGBA: ' + Array.from(imageData).join(',');
                } else {
                    resultElement.textContent = 'Erro ao obter contexto GPU 3.';
                }
            }

            function testGPUMemory4() {
                prepareData();
                const canvas = document.getElementById('gpuCanvas4');
                const ctx = canvas.getContext('2d');
                const resultElement = document.getElementById('gpuResult4');
                if (ctx) {
                    ctx.fillStyle = 'red';
                    ctx.fillRect(0, 0, 8, 8);
                    ctx.fillStyle = 'blue';
                    ctx.fillRect(8, 8, 8, 8);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                    // Tentativa de ler alguns pixels espaçados
                    const sampledData = [
                        imageData[0], imageData[1], imageData[2], imageData[3], // (0,0) Red
                        imageData[4 * 8 * 4 + 0], imageData[4 * 8 * 4 + 1], imageData[4 * 8 * 4 + 2], imageData[4 * 8 * 4 + 3], // (8,0) ?
                        imageData[8 * 8 * 4 + 0], imageData[8 * 8 * 4 + 1], imageData[8 * 8 * 4 + 2], imageData[8 * 8 * 4 + 3], // (0,8) ?
                        imageData[12 * 12 * 4 + 0], imageData[12 * 12 * 4 + 1], imageData[12 * 12 * 4 + 2], imageData[12 * 12 * 4 + 3] // (12,12) Blue
                    ];
                    resultElement.textContent = 'Leitura Amostrada RGBA: ' + sampledData.join(',');
                } else {
                    resultElement.textContent = 'Erro ao obter contexto GPU 4.';
                }
            }

            document.getElementById('gpuButton1').addEventListener('click', testGPUMemory1);
            document.getElementById('gpuButton2').addEventListener('click', testGPUMemory2);
            document.getElementById('gpuButton3').addEventListener('click', testGPUMemory3);
            document.getElementById('gpuButton4').addEventListener('click', testGPUMemory4);
        })();

        // --- Teste 2: Exploração da API Canvas 2D (Leitura/Escrita Precisa e Robustos) ---
        (function() {
            const testName = "Teste 2: Exploração da API Canvas 2D (Leitura/Escrita Precisa e Robustos)";
            log(`\n--- ${testName} ---`, 'critical');

            function testCanvasRWRobust() {
                prepareData();
                const rwCanvas1 = document.getElementById('rwCanvas1');
                const rwCanvas2 = document.getElementById('rwCanvas2');
                const readCanvasButton = document.getElementById('readCanvasButton');
                const rwResult1 = document.getElementById('rwResult1');
                const rwResult2 = document.getElementById('rwResult2');
                const readCanvasResult = document.getElementById('readCanvasResult');
                const patternCanvas = document.getElementById('patternCanvas');
                const patternCanvasResult = document.getElementById('patternCanvasResult');

                rwCanvas1.addEventListener('click', function() {
                    const ctx = this.getContext('2d');
                    if (ctx) {
                        ctx.fillStyle = 'purple';
                        ctx.fillRect(0, 0, 1, 1);
                        const data = ctx.getImageData(0, 0, 1, 1).data;
                        rwResult1.textContent = 'Canvas 1 (1x1): Desenhado roxo, lido RGBA: ' + Array.from(data).join(',');
                    } else {
                        rwResult1.textContent = 'Erro Canvas 1.';
                    }
                });

                rwCanvas2.addEventListener('click', function() {
                    const ctx = this.getContext('2d');
                    if (ctx) {
                        ctx.fillStyle = 'olive';
                        ctx.fillRect(0, 1, 1, 1);
                        const data = ctx.getImageData(0, 1, 1, 1).data;
                        rwResult2.textContent = 'Canvas 2 (1x2): Desenhado azeitona, lido RGBA (pixel 1): ' + Array.from(data).join(',');
                    } else {
                        rwResult2.textContent = 'Erro Canvas 2.';
                    }
                });

                readCanvasButton.addEventListener('click', function() {
                    const ctx = rwCanvas1.getContext('2d');
                    if (ctx) {
                        try {
                            const imageData = ctx.getImageData(0, 0, rwCanvas1.width, rwCanvas1.height);
                            readCanvasResult.textContent = 'Lido área (2x1) RGBA: ' + Array.from(new Uint8Array(imageData.data.buffer)).join(',');
                        } catch (e) {
                            readCanvasResult.textContent = 'Erro ao ler área: ' + e;
                        }
                    } else {
                        readCanvasResult.textContent = 'Erro ao obter contexto para leitura de área.';
                    }
                });

                setTimeout(function() {
                    const patternButton = document.createElement('button');
                    patternButton.textContent = 'Clique para testar padrão R/W';
                    patternButton.addEventListener('click', function() {
                        const ctx = patternCanvas.getContext('2d');
                        if (ctx) {
                            const writeData = new Uint8Array([255, 0, 0, 255, 0, 0, 255, 255]); // Vermelho, Azul
                            const imageDataWrite = new ImageData(new Uint8ClampedArray(writeData.buffer), patternCanvas.width, patternCanvas.height);
                            ctx.putImageData(imageDataWrite, 0, 0);
                            patternCanvasResult.textContent = 'Padrão escrito (vermelho, azul).';
                            setTimeout(() => {
                                const readImageData = ctx.getImageData(0, 0, patternCanvas.width, patternCanvas.height);
                                const readArray = Array.from(new Uint8Array(readImageData.data.buffer));
                                patternCanvasResult.textContent += '\\nLido (RGBA): ' + readArray.join(',');
                            }, 100);
                        } else {
                            patternCanvasResult.textContent = 'Erro ao obter contexto para padrão.';
                        }
                    });
                    document.getElementById('patternCanvasContainer').appendChild(patternButton);
                }, 500);
            }

            testCanvasRWRobust();
        })();

        // --- Teste 4: Analisar a Disposição da Memória ---
        (function() {
            const testName = "Teste 4: Analisar a Disposição da Memória";
            log(`\n--- ${testName} ---`, 'critical');

            function testMemoryLayout1() {
                prepareData();
                const resultElement = document.getElementById('memoryLayoutResult1');
                try {
                    const buffer1 = new ArrayBuffer(32);
                    const view1 = new Uint8Array(buffer1);
                    for (let i = 0; i < view1.length; i++) {
                        view1[i] = i;
                    }
                    let readValues = [];
                    for (let i = 0; i < view1.length; i++) {
                        readValues.push(view1[i]);
                    }
                    resultElement.textContent = 'Leitura Sequencial: ' + readValues.join(',');
                } catch (e) {
                    resultElement.textContent = 'Erro Layout 1: ' + e;
                }
            }

            function testMemoryLayout2() {
                prepareData();
                const resultElement = document.getElementById('memoryLayoutResult2');
                try {
                    const buffer2 = new ArrayBuffer(64);
                    const view2 = new Uint32Array(buffer2);
                    for (let i = 0; i < view2.length; i++) {
                        view2[i] = i * 4;
                    }
                    let readValues = [];
                    for (let i = 0; i < view2.length; i++) {
                        readValues.push(view2[i]);
                    }
                    resultElement.textContent = 'Leitura Espaçada (Uint32): ' + readValues.join(',');
                } catch (e) {
                    resultElement.textContent = 'Erro Layout 2: ' + e;
                }
            }

            function testMemoryLayout3() {
                prepareData();
                const resultElement = document.getElementById('memoryLayoutResult3');
                let bufferInfo = [];
                for (let prop in window) {
                    try {
                        if (window[prop] instanceof ArrayBuffer) {
                            bufferInfo.push(`${prop}: Size ${window[prop].byteLength}`);
                        }
                    } catch (e) {
                        // Ignorar erros ao acessar propriedades
                    }
                }
                resultElement.textContent = 'Buffers Globais: ' + bufferInfo.join('; ');
            }

            function testMemoryLayout4() {
                prepareData();
                const resultElement = document.getElementById('memoryLayoutResult4');
                try {
                    const buffer3 = new ArrayBuffer(32);
                    const view3 = new Uint8Array(buffer3);
                    const buffer4 = new ArrayBuffer(32);
                    const view4 = new Uint8Array(buffer4);

                    for (let i = 0; i < view3.length; i++) {
                        view3[i] = i * 2;
                    }

                    // Tentativa de acessar memória fora dos limites (pode gerar erro ou comportamento indefinido)
                    let overlapAttempt = view3
