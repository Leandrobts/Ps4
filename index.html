<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PoC v15.4 - Debugging Fluxo</title>
    <style>/* ... Estilos ... */</style>
</head>
<body>
    <h1>PoC v15.4 - Debugging Fluxo</h1>
    <canvas id="webgl-canvas" width="1" height="1" style="display: none;"></canvas>
    <canvas id="fingerprint-canvas" width="350" height="200"></canvas>
    <div id="canvas-coord-status">Passe o mouse sobre o canvas ↑</div>
    <p>Fase 1: PoC Original. Fase 2: Aprofundamento. DEBUGANDO FLUXO.</p>
    <button id="runBtn" onclick="runEverythingSequentially()">Iniciar Teste Completo (Debug)</button>
    <div id="output"></div>
    <div id="xss-target-div">Área para teste de XSS DOM.</div>

    <script>
        // --- Globals & Setup ---
        // ... (globals anteriores: outputDiv, runBtn, fingerprintCanvas, coordStatusDiv, pauses, OOB var, listeners, xss flag, finalResults) ...
        const log = (message, type = 'info') => { /* ... (implementação anterior) ... */ };
        const toHex = (val, bits = 32) => { /* ... (implementação anterior) ... */ };
        const isPotentialPointer64 = (high, low) => { /* ... (heurística) ... */ };
        const isPotentialData32 = (val) => { /* ... (heurística) ... */ };
        const logFinalSummary = () => { /* ... (implementação anterior) ... */ };

        // ==================================================
        // --- FASE 1: Testes Originais (Preservados + Fix XSS Flag) ---
        // ==================================================
        log("Definindo Testes da Fase 1 (Originais)", "info");
        const originalTestCSPBypass = async () => { log("--- [Fase 1] T1: XSS Iniciando ---", 'test'); /* ... código T1 v15.3 ... */ await new Promise(r=>setTimeout(r, MEDIUM_PAUSE)); finalResults.phase1_xss_flag = xssRanFlag; log(`--- [Fase 1] T1: XSS Concluído (Flag=${xssRanFlag}) ---`, 'test'); };
        const originalTestOOBReadInfoLeak = async () => { log("--- [Fase 1] T2: OOB Iniciando ---", 'test'); /* ... código T2 v15.3 ... */ finalResults.phase1_oob_stored = !!leakedValueFromOOB; log(`--- [Fase 1] T2: OOB Concluído (Stored=${!!leakedValueFromOOB}) ---`, 'test'); return true; };
        const originalTestBasicPP = async () => { log("--- [Fase 1] T3: PP Básica Iniciando ---", 'test'); let success = false; /* ... código T3 v15.3 ... */ finalResults.phase1_pp_basic = success; log(`--- [Fase 1] T3: PP Básica Concluído (Success=${success}) ---`, 'test'); return success; };
        const originalTestPPJsonHijack = async () => { log("--- [Fase 1] T4: PP Hijack Iniciando ---", 'test'); let success = false; /* ... código T4 v15.3 ... */ finalResults.phase1_pp_hijack = success; log(`--- [Fase 1] T4: PP Hijack Concluído (Success=${success}) ---`, 'test'); return success; };

        // Função para rodar a Fase 1
        const runOriginalTests = async () => {
             log("==== [Fase 1] INICIANDO runOriginalTests ====", 'critical');
             await originalTestCSPBypass(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE));
             await originalTestOOBReadInfoLeak(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE));
             await originalTestBasicPP(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE));
             await originalTestPPJsonHijack(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE));
             log("==== [Fase 1] runOriginalTests CONCLUÍDA ====", 'critical');
             log(`==== [Fase 1] Estado Final Interno: xssFlag=${xssRanFlag}, OOB=${leakedValueFromOOB?'Stored':'null'} ====`,'info');
        }

        // ==========================================================
        // --- FASE 2: Testes Adicionais Baseados em Evidências ---
        // ==========================================================
        log("Definindo Testes da Fase 2 (Aprofundamento)", "info");
        // Teste A: Coleta Dados Básicos
        const testBasicDataCollection = async () => { log("--- [Fase 2] A: Coleta Dados Iniciando ---", 'test'); /* ... */ log("--- [Fase 2] A: Coleta Dados Concluído ---", 'test'); };
        // Teste B: Sondagem Ambiente
        const testEnvironmentProbing = async () => { log("--- [Fase 2] B: Sondagem Ambiente Iniciando ---", 'test'); /* ... */ log("--- [Fase 2] B: Sondagem Ambiente Concluído ---", 'test'); };
        // Teste C: Fingerprinting Avançado
        const testAdvancedFingerprinting = async () => { log("--- [Fase 2] C: Fingerprinting Adv Iniciando ---", 'test'); /* ... */ log("--- [Fase 2] C: Fingerprinting Adv Concluído ---", 'test'); };
        // Teste F: Observação Erros Detalhada
        const testErrorObservation = async () => { log("--- [Fase 2] F: Observação Erros Iniciando ---", 'test'); /* ... */ log("--- [Fase 2] F: Observação Erros Concluído ---", 'test'); };
        // Teste J: PP Avançada
        const testAdvancedPP = async () => { log("--- [Fase 2] J: PP Avançada Iniciando ---", 'test'); /* ... */ finalResults.phase2_pp_advanced = true; log("--- [Fase 2] J: PP Avançada Concluído ---", 'test'); };
        // Teste K: Tentativas PP Gadget
        const testPPGadgetAttempts = async () => { log("--- [Fase 2] K: PP Gadgets Iniciando ---", 'test'); /* ... */ finalResults.phase2_pp_gadgets = true; log("--- [Fase 2] K: PP Gadgets Concluído ---", 'test'); };
        // Teste D/E: Canvas Completo
        const testComprehensiveCanvas = async () => { log("--- [Fase 2] D/E: Canvas Completo Iniciando ---", 'test'); /* ... (código T D/E v15.3) ... */ log("--- [Fase 2] D/E: Canvas Completo Concluído ---", 'test'); };

        // Função para rodar a Fase 2
        const runNewTests = async () => {
            log("==== [Fase 2] INICIANDO runNewTests ====", 'critical');
            // Ordem: Coleta -> Erros -> PP -> Canvas
            await testBasicDataCollection(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE)); // A
            await testEnvironmentProbing(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE)); // B
            await testAdvancedFingerprinting(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE)); // C
            await testErrorObservation(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE)); // F
            await testAdvancedPP(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE)); // J
            await testPPGadgetAttempts(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE)); // K
            await testComprehensiveCanvas(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE)); // D/E Combinado
            log("==== [Fase 2] runNewTests CONCLUÍDA ====", 'critical');
        }

        // --- Função Principal ---
        const runEverythingSequentially = async () => {
            if (runBtn) runBtn.disabled = true;
            log("==== INICIANDO PoC Final v15.4 (Debugging Fluxo) ====", 'critical');
            finalResults = {}; // Reseta resumo

            log(">>> Chamando runOriginalTests <<<", 'warn');
            try {
                await runOriginalTests(); // Roda Fase 1
                log(">>> runOriginalTests CONCLUÍDO (sem erro capturado aqui) <<<", 'warn');
            } catch (error) {
                log(`>>> ERRO CAPTURADO DURANTE runOriginalTests: ${error.name} - ${error.message} <<<`, 'error');
                log(error.stack || '(sem stack trace)', 'error');
            }

            log("\n>>> Pausa Entre Fases (Real) <<<\n", "warn");
            await new Promise(r => setTimeout(r, MEDIUM_PAUSE * 2));

            log(">>> Chamando runNewTests <<<", 'warn');
            try {
                await runNewTests(); // Roda Fase 2
                log(">>> runNewTests CONCLUÍDO (sem erro capturado aqui) <<<", 'warn');
            } catch (error) {
                 log(`>>> ERRO CAPTURADO DURANTE runNewTests: ${error.name} - ${error.message} <<<`, 'error');
                 log(error.stack || '(sem stack trace)', 'error');
            }


            log("\n==== PoC Final v15.4 CONCLUÍDA ====", 'critical');
            try {
                logFinalSummary(); // Loga o resumo coletado
            } catch(e) { log("Erro ao gerar resumo final", "error"); }
            log("Listeners de clique/movimento do Canvas podem continuar ativos.", "warn");
            if (runBtn) runBtn.disabled = false;
        };

        // Limpeza listeners, etc.
        window.addEventListener('unload', () => { /* ... */ });
        // document.addEventListener('DOMContentLoaded', runEverythingSequentially);

    </script>

</body>
</html>
