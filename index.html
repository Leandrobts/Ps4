<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit Exploit - Testes Isolados e Robustos (Corrigido)</title>
</head>
<body>
    <h1>Testes Isolados e Robustos (Corrigido)</h1>
    <div id="output"></div>

    <h2>Teste 1: Primitiva de Modificação de Propriedades (Robustos)</h2>
    <div id="propTarget1" data-original="Valor A" style="border: 1px solid black; padding: 10px; margin: 5px; cursor: pointer;">Clique para modificar dataset</div>
    <pre id="propResult1"></pre>
    <div id="propTarget2" style="border: 1px solid black; padding: 10px; margin: 5px; cursor: pointer; background-color: #f0f0f0;">Clique para modificar style</div>
    <pre id="propResult2"></pre>
    <div id="propTarget3" customAttr="Initial" style="border: 1px solid black; padding: 10px; margin: 5px; cursor: pointer;">Clique para modificar atributo customizado</div>
    <pre id="propResult3"></pre>
    <div id="propTarget4" style="border: 1px solid black; padding: 10px; margin: 5px; cursor: pointer;">Clique para tentar modificar prototype</div>
    <pre id="propResult4"></pre>
    <hr>

    <h2>Teste 2: Exploração da API Canvas 2D (Leitura/Escrita Precisa e Robustos)</h2>
    <canvas id="rwCanvas1" width="2" height="1" style="border: 1px solid black; cursor: pointer;"></canvas>
    <pre id="rwResult1"></pre>
    <canvas id="rwCanvas2" width="1" height="2" style="border: 1px solid black; cursor: pointer; margin-top: 5px;"></canvas>
    <pre id="rwResult2"></pre>
    <button id="readCanvasButton">Clique para ler área maior do canvas</button>
    <pre id="readCanvasResult"></pre>
    <button id="patternCanvasButton">Clique para testar padrão R/W</button>
    <pre id="patternCanvasResult"></pre>
    <hr>

    <h2>Teste 3: Tentativa de Primitiva de Leitura de Memória (Exploratória e Robustos)</h2>
    <button id="memoryReadButton1">Tentar ler ArrayBuffer (indiretamente - global)</button>
    <pre id="memoryReadResult1"></pre>
    <button id="memoryReadButton2">Tentar ler propriedade de objeto (indiretamente - global)</button>
    <pre id="memoryReadResult2"></pre>
    <button id="memoryReadButton3">Tentar vazar informações de erro (global)</button>
    <pre id="memoryReadResult3"></pre>
    <button id="memoryReadButton4">Tentar ler com `atob`/`btoa` (global)</button>
    <pre id="memoryReadResult4"></pre>

    <script>
        const log = (message, type = 'info') => {
            const outputDiv = document.getElementById('output');
            if (outputDiv) {
                outputDiv.innerHTML += `<span style="color: <span class="math-inline">\{type \=\=\= 'error' ? 'red' \: type \=\=\= 'warning' ? 'orange' \: 'blue'\};"\></span>{new Date().toLocaleTimeString()} - ${message}\n</span>`;
            } else {
                console.error('Elemento #output não encontrado!');
            }
        };

        function prepareData() {
            log("Função prepareData() iniciada e concluída (para consistência).", 'info');
            let bufferSize = 64;
            let buffer = new ArrayBuffer(bufferSize);
            let view = new Uint8Array(buffer);
            return { buffer, view, bufferSize };
        }

        function testPropertyModificationRobust() {
            log("\n--- Teste 1: Primitiva de Modificação de Propriedades (Robustos) ---", 'critical');
            prepareData();
            document.getElementById('propTarget1').setAttribute('onclick', `try { this.dataset.newValue = 'MODIFICADO DATASET ROBUSTO!'; document.getElementById('propResult1').textContent = 'dataset.newValue: ' + this.dataset.newValue; } catch (e) { document.getElementById('propResult1').textContent = 'Erro dataset: ' + e; }`);
            document.getElementById('propTarget2').setAttribute('onclick', `try { this.style.backgroundColor = 'coral'; this.style.color = 'black'; document.getElementById('propResult2').textContent = 'style modificado ROBUSTO!'; } catch (e) { document.getElementById('propResult2').textContent = 'Erro style: ' + e; }`);
            document.getElementById('propTarget3').setAttribute('onclick', `try { this.setAttribute('customAttr', 'ROBUSTO!'); document.getElementById('propResult3').textContent = 'customAttr: ' + this.getAttribute('customAttr'); } catch (e) { document.getElementById('propResult3').textContent = 'Erro customAttr: ' + e; }`);
            document.getElementById('propTarget4').setAttribute('onclick', `try { Object.prototype.injectedProperty = 'INJECTED!'; document.getElementById('propResult4').textContent = 'Tentativa de modificar prototype (pode falhar silenciosamente).'; } catch (e) { document.getElementById('propResult4').textContent = 'Erro prototype: ' + e; }`);
        }

        function testCanvasRWRobust() {
            log("\n--- Teste 2: Exploração da API Canvas 2D (Leitura/Escrita Precisa e Robustos) ---", 'critical');
            prepareData();
            document.getElementById('rwCanvas1').setAttribute('onclick', `const ctx = this.getContext('2d'); if (ctx) { ctx.fillStyle = 'purple'; ctx.fillRect(0, 0, 1, 1); const data = ctx.getImageData(0, 0, 1, 1).data; document.getElementById('rwResult1').textContent = 'Canvas 1 (1x1): Desenhado roxo, lido RGBA: ' + Array.from(data).join(','); } else { document.getElementById('rwResult1').textContent = 'Erro Canvas 1.'; }`);
            document.getElementById('rwCanvas2').setAttribute('onclick', `const ctx = this.getContext('2d'); if (ctx) { ctx.fillStyle = 'olive'; ctx.fillRect(0, 1, 1, 1); const data = ctx.getImageData(0, 1, 1, 1).data; document.getElementById('rwResult2').textContent = 'Canvas 2 (1x2): Desenhado azeitona, lido RGBA (pixel 1): ' + Array.from(data).join(','); } else { document.getElementById('rwResult2').textContent = 'Erro Canvas 2.'; }`);
            document.getElementById('readCanvasButton').setAttribute('onclick', `const canvas = document.getElementById('rwCanvas1'); const ctx = canvas.getContext('2d'); if (ctx) { try { const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height); document.getElementById('readCanvasResult').textContent = 'Lido área (2x1) RGBA: ' + Array.from(new Uint8Array(imageData.data.buffer)).join(','); } catch (e) { document.getElementById('readCanvasResult').textContent = 'Erro ao ler área: ' + e; } } else { document.getElementById('readCanvasResult').textContent = 'Erro ao obter contexto para leitura de área.'; }`);

            const patternButton = document.getElementById('patternCanvasButton');
            patternButton.setAttribute('onclick', function() {
                const canvas = document.getElementById('patternCanvas');
                const ctx = canvas.getContext('2d');
                const resultElement = document.getElementById('patternCanvasResult');
                if (ctx) {
                    const writeData = new Uint8Array([255, 0, 0
