<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit Exploit - Testes Isolados (IIFE)</title>
</head>

<body>
    <h1>Testes Isolados (IIFE)</h1>
    <div id="output"></div>

    <h2>Teste 1: Primitiva de Modificação de Propriedades (Robustos)</h2>
    <div id="propTarget1" data-original="Valor A" style="border: 1px solid black; padding: 10px; margin: 5px; cursor: pointer;">Clique para modificar dataset</div>
    <pre id="propResult1"></pre>
    <div id="propTarget2" style="border: 1px solid black; padding: 10px; margin: 5px; cursor: pointer; background-color: #f0f0f0;">Clique para modificar style</div>
    <pre id="propResult2"></pre>
    <div id="propTarget3" customAttr="Initial" style="border: 1px solid black; padding: 10px; margin: 5px; cursor: pointer;">Clique para modificar atributo customizado</div>
    <pre id="propResult3"></pre>
    <div id="propTarget4" style="border: 1px solid black; padding: 10px; margin: 5px; cursor: pointer;">Clique para tentar modificar prototype</div>
    <pre id="propResult4"></pre>
    <hr>

    <h2>Teste 2: Exploração da API Canvas 2D (Leitura/Escrita Precisa e Robustos)</h2>
    <canvas id="rwCanvas1" width="2" height="1" style="border: 1px solid black; cursor: pointer;"></canvas>
    <pre id="rwResult1"></pre>
    <canvas id="rwCanvas2" width="1" height="2" style="border: 1px solid black; cursor: pointer; margin-top: 5px;"></canvas>
    <pre id="rwResult2"></pre>
    <button id="readCanvasButton">Clique para ler área maior do canvas</button>
    <pre id="readCanvasResult"></pre>
    <div id="patternCanvasContainer">
        <canvas id="patternCanvas" width="2" height="1" style="border: 1px solid black; cursor: pointer;"></canvas>
        <pre id="patternCanvasResult"></pre>
    </div>
    <hr>

    <h2>Teste 3: Tentativa de Primitiva de Leitura de Memória (Exploratória e Robustos)</h2>
    <button id="memoryReadButton1">Tentar ler ArrayBuffer (indiretamente - global)</button>
    <pre id="memoryReadResult1"></pre>
    <button id="memoryReadButton2">Tentar ler propriedade de objeto (indiretamente - global)</button>
    <pre id="memoryReadResult2"></pre>
    <button id="memoryReadButton3">Tentar vazar informações de erro (global)</button>
    <pre id="memoryReadResult3"></pre>
    <button id="memoryReadButton4">Tentar ler com `atob`/`btoa` (global)</button>
    <pre id="memoryReadResult4"></pre>

    <script>
        const log = (message, type = 'info') => {
            const outputDiv = document.getElementById('output');
            if (outputDiv) {
                outputDiv.innerHTML += `<span style="color: ${type === 'error' ? 'red' : type === 'warning' ? 'orange' : 'blue'};">${new Date().toLocaleTimeString()} - ${message}\n</span>`;
            } else {
                console.error('Elemento #output não encontrado!');
            }
        };

        function prepareData() {
            log("Função prepareData() iniciada e concluída (para consistência).", 'info');
            let bufferSize = 64;
            let buffer = new ArrayBuffer(bufferSize);
            let view = new Uint8Array(buffer);
            return {
                buffer,
                view,
                bufferSize
            };
        }

        // --- Teste 1: Primitiva de Modificação de Propriedades (Robustos) ---
        (function() {
            const testName = "Teste 1: Primitiva de Modificação de Propriedades (Robustos)";
            log(`\n--- ${testName} ---`, 'critical');

            function testPropertyModificationRobust() {
                prepareData();
                const propTarget1 = document.getElementById('propTarget1');
                const propTarget2 = document.getElementById('propTarget2');
                const propTarget3 = document.getElementById('propTarget3');
                const propTarget4 = document.getElementById('propTarget4');
                const propResult1 = document.getElementById('propResult1');
                const propResult2 = document.getElementById('propResult2');
                const propResult3 = document.getElementById('propResult3');
                const propResult4 = document.getElementById('propResult4');

                propTarget1.addEventListener('click', function() {
                    try {
                        this.dataset.newValue = 'MODIFICADO DATASET ROBUSTO!';
                        propResult1.textContent = 'dataset.newValue: ' + this.dataset.newValue;
                    } catch (e) {
                        propResult1.textContent = 'Erro dataset: ' + e;
                    }
                });

                propTarget2.addEventListener('click', function() {
                    try {
                        this.style.backgroundColor = 'coral';
                        this.style.color = 'black';
                        propResult2.textContent = 'style modificado ROBUSTO!';
                    } catch (e) {
                        propResult2.textContent = 'Erro style: ' + e;
                    }
                });

                propTarget3.addEventListener('click', function() {
                    try {
                        this.setAttribute('customAttr', 'ROBUSTO!');
                        propResult3.textContent = 'customAttr: ' + this.getAttribute('customAttr');
                    } catch (e) {
                        propResult3.textContent = 'Erro customAttr: ' + e;
                    }
                });

                propTarget4.addEventListener('click', function() {
                    try {
                        Object.prototype.injectedProperty = 'INJECTED!';
                        propResult4.textContent = 'Tentativa de modificar prototype (pode falhar silenciosamente).';
                    } catch (e) {
                        propResult4.textContent = 'Erro prototype: ' + e;
                    }
                });
            }

            testPropertyModificationRobust();
        })();

        // --- Teste 2: Exploração da API Canvas 2D (Leitura/Escrita Precisa e Robustos) ---
        (function() {
            const testName = "Teste 2: Exploração da API Canvas 2D (Leitura/Escrita Precisa e Robustos)";
            log(`\n--- ${testName} ---`, 'critical');

            function testCanvasRWRobust() {
                prepareData();
                const rwCanvas1 = document.getElementById('rwCanvas1');
                const rwCanvas2 = document.getElementById('rwCanvas2');
                const readCanvasButton = document.getElementById('readCanvasButton');
                const rwResult1 = document.getElementById('rwResult1');
                const rwResult2 = document.getElementById('rwResult2');
                const readCanvasResult = document.getElementById('readCanvasResult');
                const patternCanvas = document.getElementById('patternCanvas');
                const patternCanvasResult = document.getElementById('patternCanvasResult');

                rwCanvas1.addEventListener('click', function() {
                    const ctx = this.getContext('2d');
                    if (ctx) {
                        ctx.fillStyle = 'purple';
                        ctx.fillRect(0, 0, 1, 1);
                        const data = ctx.getImageData(0, 0, 1, 1).data;
                        rwResult1.textContent = 'Canvas 1 (1x1): Desenhado roxo, lido RGBA: ' + Array.from(data).join(',');
                    } else {
                        rwResult1.textContent = 'Erro Canvas 1.';
                    }
                });

                rwCanvas2.addEventListener('click', function() {
                    const ctx = this.getContext('2d');
                    if (ctx) {
                        ctx.fillStyle = 'olive';
                        ctx.fillRect(0, 1, 1, 1);
                        const data = ctx.getImageData(0, 1, 1, 1).data;
                        rwResult2.textContent = 'Canvas 2 (1x2): Desenhado azeitona, lido RGBA (pixel 1): ' + Array.from(data).join(',');
                    } else {
                        rwResult2.textContent = 'Erro Canvas 2.';
                    }
                });

                readCanvasButton.addEventListener('click', function() {
                    const ctx = rwCanvas1.getContext('2d');
                    if (ctx) {
                        try {
                            const imageData = ctx.getImageData(0, 0, rwCanvas1.width, rwCanvas1.height);
                            readCanvasResult.textContent = 'Lido área (2x1) RGBA: ' + Array.from(new Uint8Array(imageData.data.buffer)).join(',');
                        } catch (e) {
                            readCanvasResult.textContent = 'Erro ao ler área: ' + e;
                        }
                    } else {
                        readCanvasResult.textContent = 'Erro ao obter contexto para leitura de área.';
                    }
                });

                setTimeout(function() {
                    const patternButton = document.createElement('button');
                    patternButton.textContent = 'Clique para testar padrão R/W';
                    patternButton.addEventListener('click', function() {
                        const ctx = patternCanvas.getContext('2d');
                        if (ctx) {
                            const writeData = new Uint8Array([255, 0, 0, 255, 0, 0, 255, 255]); // Vermelho, Azul
                            const imageDataWrite = new ImageData(new Uint8ClampedArray(writeData.buffer), patternCanvas.width, patternCanvas.height);
                            ctx.putImageData(imageDataWrite, 0, 0);
                            patternCanvasResult.textContent = 'Padrão escrito (vermelho, azul).';
                            setTimeout(() => {
                                const readImageData = ctx.getImageData(0, 0, patternCanvas.width, patternCanvas.height);
                                const readArray = Array.from(new Uint8Array(readImageData.data.buffer));
                                patternCanvasResult.textContent += '\\nLido (RGBA): ' + readArray.join(',');
                            }, 100);
                        } else {
                            patternCanvasResult.textContent = 'Erro ao obter contexto para padrão.';
                        }
                    });
                    document.getElementById('patternCanvasContainer').appendChild(patternButton);
                }, 500);
            }

            testCanvasRWRobust();
        })();

        // --- Teste 3: Tentativa de Primitiva de Leitura de Memória (Exploratória e Robustos) ---
        (function() {
            const testName = "Teste 3: Tentativa de Primitiva de Leitura de Memória (Exploratória e Robustos)";
            log(`\n--- ${testName} ---`, 'critical');

            let globalLeakedBuffer;
            let globalLeakedObject;

            function attemptMemoryReadRobust() {
                prepareData();
                const memoryReadButton1 = document.getElementById('memoryReadButton1');
                const memoryReadButton2 = document.getElementById('memoryReadButton2');
                const memoryReadButton3 = document.getElementById('memoryReadButton3');
                const memoryReadButton4 = document.getElementById('memoryReadButton4');
                const memoryReadResult1 = document.getElementById('memoryReadResult1');
                const memoryReadResult2 = document.getElementById('memoryReadResult2');
                const memoryReadResult3 = document.getElementById('memoryReadResult3');
                const memoryReadResult4 = document.getElementById('memoryReadResult4');

                globalLeakedBuffer = new ArrayBuffer(8);
                const view = new Uint8Array(globalLeakedBuffer);
                view[0] = 0x41;
                view[1] = 0x42;

                globalLeakedObject = {
                    secret1: "AAA",
                    secret2: "BBB"
                };

                memoryReadButton1.addEventListener('click', function() {
                    try {
                        let temp = new Uint8Array(globalLeakedBuffer);
                        memoryReadResult1.textContent = 'Tentativa leitura AB (indireta - global): ' + temp[0] + ',' + temp[1];
                        temp = null;
                    } catch (e) {
                        memoryReadResult1.textContent = 'Erro: ' + e;
                    }
                });

                memoryReadButton2.addEventListener('click', function() {
                    try {
                        memoryReadResult2.textContent = 'Tentativa leitura obj (indireta - global): ' + globalLeakedObject.secret1 + ',' + globalLeakedObject.secret2;
                    } catch (e) {
                        memoryReadResult2.textContent = 'Erro: ' + e;
                    }
                });

                memoryReadButton3.addEventListener('click', function() {
                    try {
                        throw new Error('Teste de Erro com Dados Sensíveis: ' + globalLeakedBuffer);
                    } catch (e) {
                        memoryReadResult3.textContent = 'Informação de erro (global - pode vazar dados): ' + e.message;
                    }
                });

                memoryReadButton4.addEventListener('click', function() {
                    try {
                        const base64 = btoa(String.fromCharCode.apply(null, new Uint8Array(globalLeakedBuffer)));
                        memoryReadResult4.textContent = 'Tentativa leitura com btoa (global): ' + base64;
                        const decoded = atob(base64);
                        memoryReadResult4.textContent += '\\nDecodificado: ' + decoded.charCodeAt(0) + ',' + decoded.charCodeAt(1);
                    } catch (e) {
                        memoryReadResult4.textContent = 'Erro btoa/atob (global): ' + e.message;
                    }
                });
            }

            attemptMemoryReadRobust();
        })();
    </script>
</body>

</html>
