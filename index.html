<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit Exploit - Testes Isolados e Robustos (Debug Teste 2 - Timeout)</title>
</head>
<body>
    <h1>Testes Isolados e Robustos (Debug Teste 2 - Timeout)</h1>
    <div id="output"></div>

    <h2>Teste 2: Exploração da API Canvas 2D (Leitura/Escrita Precisa e Robustos)</h2>
    <canvas id="patternCanvas" width="2" height="1" style="border: 1px solid black; cursor: pointer;"></canvas>
    <pre id="patternCanvasResult"></pre>

    <script>
        const log = (message, type = 'info') => {
            const outputDiv = document.getElementById('output');
            if (outputDiv) {
                outputDiv.innerHTML += `<span style="color: ${type === 'error' ? 'red' : type === 'warning' ? 'orange' : 'blue'};">${new Date().toLocaleTimeString()} - ${message}\n</span>`;
            } else {
                console.error('Elemento #output não encontrado!');
            }
        };

        function prepareData() {
            log("Função prepareData() iniciada e concluída (para consistência).", 'info');
            let bufferSize = 64;
            let buffer = new ArrayBuffer(bufferSize);
            let view = new Uint8Array(buffer);
            return { buffer, view, bufferSize };
        }

        function testCanvasPatternRWTimeout() {
            const patternButton = document.createElement('button');
            patternButton.textContent = 'Clique para testar padrão R/W (Timeout)';
            patternButton.onclick = function() {
                const canvas = document.getElementById('patternCanvas');
                const ctx = canvas.getContext('2d');
                const resultElement = document.getElementById('patternCanvasResult');
                if (ctx) {
                    const writeData = new Uint8Array([255, 0, 0, 255, 0, 0, 255, 255]); // Vermelho, Azul
                    const imageDataWrite = new ImageData(new Uint8ClampedArray(writeData.buffer), canvas.width, canvas.height);
                    ctx.putImageData(imageDataWrite, 0, 0);
                    resultElement.textContent = 'Padrão escrito (vermelho, azul) - Timeout.';
                    setTimeout(() => {
                        const readImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const readArray = Array.from(new Uint8Array(readImageData.data.buffer));
                        resultElement.textContent += '\\nLido (RGBA): ' + readArray.join(',');
                    }, 100);
                } else {
                    resultElement.textContent = 'Erro ao obter contexto para padrão - Timeout.';
                }
            };
            document.body.appendChild(patternButton);
        }

        function mainExploit() {
            log("mainExploit() iniciado.", 'critical');
            prepareData();
            setTimeout(testCanvasPatternRWTimeout, 500); // Adicionando um pequeno delay
            log("mainExploit() concluído.", 'critical');
        }

        mainExploit();
    </script>
</body>
</html>
