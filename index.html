<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit Exploit - Teste Canvas (Isolado)</title>
</head>

<body>
    <h1>Teste Canvas (Isolado)</h1>
    <div id="output"></div>

    <h2>Teste 2: Exploração da API Canvas 2D (Leitura/Escrita Precisa e Robustos)</h2>
    <canvas id="rwCanvas1" width="2" height="1" style="border: 1px solid black; cursor: pointer;"></canvas>
    <pre id="rwResult1"></pre>
    <canvas id="rwCanvas2" width="1" height="2" style="border: 1px solid black; cursor: pointer; margin-top: 5px;"></canvas>
    <pre id="rwResult2"></pre>
    <button id="readCanvasButton">Clique para ler área maior do canvas</button>
    <pre id="readCanvasResult"></pre>
    <div id="patternCanvasContainer">
        <canvas id="patternCanvas" width="2" height="1" style="border: 1px solid black; cursor: pointer;"></canvas>
        <pre id="patternCanvasResult"></pre>
    </div>

    <script>
        const log = (message, type = 'info') => {
            const outputDiv = document.getElementById('output');
            if (outputDiv) {
                outputDiv.innerHTML += `<span style="color: ${type === 'error' ? 'red' : type === 'warning' ? 'orange' : 'blue'};">${new Date().toLocaleTimeString()} - ${message}\n</span>`;
            } else {
                console.error('Elemento #output não encontrado!');
            }
        };

        function prepareData() {
            log("Função prepareData() iniciada e concluída (para consistência).", 'info');
            let bufferSize = 64;
            let buffer = new ArrayBuffer(bufferSize);
            let view = new Uint8Array(buffer);
            return {
                buffer,
                view,
                bufferSize
            };
        }

        function testCanvasRWRobust() {
            log("\n--- Teste 2: Exploração da API Canvas 2D (Leitura/Escrita Precisa e Robustos) ---", 'critical');
            prepareData();

            const rwCanvas1 = document.getElementById('rwCanvas1');
            const rwCanvas2 = document.getElementById('rwCanvas2');
            const readCanvasButton = document.getElementById('readCanvasButton');

            rwCanvas1.addEventListener('click', function() {
                const ctx = this.getContext('2d');
                if (ctx) {
                    ctx.fillStyle = 'purple';
                    ctx.fillRect(0, 0, 1, 1);
                    const data = ctx.getImageData(0, 0, 1, 1).data;
                    document.getElementById('rwResult1').textContent = 'Canvas 1 (1x1): Desenhado roxo, lido RGBA: ' + Array.from(data).join(',');
                } else {
                    document.getElementById('rwResult1').textContent = 'Erro Canvas 1.';
                }
            });

            rwCanvas2.addEventListener('click', function() {
                const ctx = this.getContext('2d');
                if (ctx) {
                    ctx.fillStyle = 'olive';
                    ctx.fillRect(0, 1, 1, 1);
                    const data = ctx.getImageData(0, 1, 1, 1).data;
                    document.getElementById('rwResult2').textContent = 'Canvas 2 (1x2): Desenhado azeitona, lido RGBA (pixel 1): ' + Array.from(data).join(',');
                } else {
                    document.getElementById('rwResult2').textContent = 'Erro Canvas 2.';
                }
            });

            readCanvasButton.addEventListener('click', function() {
                const canvas = document.getElementById('rwCanvas1');
                const ctx = canvas.getContext('2d');
                if (ctx) {
                    try {
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        document.getElementById('readCanvasResult').textContent = 'Lido área (2x1) RGBA: ' + Array.from(new Uint8Array(imageData.data.buffer)).join(',');
                    } catch (e) {
                        document.getElementById('readCanvasResult').textContent = 'Erro ao ler área: ' + e;
                    }
                } else {
                    document.getElementById('readCanvasResult').textContent = 'Erro ao obter contexto para leitura de área.';
                }
            });


            setTimeout(function() {
                const patternButton = document.createElement('button');
                patternButton.textContent = 'Clique para testar padrão R/W';
                patternButton.addEventListener('click', function() {
                    const canvas = document.getElementById('patternCanvas');
                    const ctx = canvas.getContext('2d');
                    const resultElement = document.getElementById('patternCanvasResult');
                    if (ctx) {
                        const writeData = new Uint8Array([255, 0, 0, 255, 0, 0, 255, 255]); // Vermelho, Azul
                        const imageDataWrite = new ImageData(new Uint8ClampedArray(writeData.buffer), canvas.width, canvas.height);
                        ctx.putImageData(imageDataWrite, 0, 0);
                        resultElement.textContent = 'Padrão escrito (vermelho, azul).';
                        setTimeout(() => {
                            const readImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const readArray = Array.from(new Uint8Array(readImageData.data.buffer));
                            resultElement.textContent += '\\nLido (RGBA): ' + readArray.join(',');
                        }, 100);
                    } else {
                        resultElement.textContent = 'Erro ao obter contexto para padrão.';
                    }
                });
                document.getElementById('patternCanvasContainer').appendChild(patternButton);
            }, 500);
        }

        document.addEventListener('DOMContentLoaded', function() {
            testCanvasRWRobust();
        });
    </script>
</body>

</html>
