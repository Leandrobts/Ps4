<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit Exploit - Testes Avançados Integrados</title>
</head>
<body>
    <h1>Testes Avançados Integrados</h1>
    <div id="output"></div>

    <h2>Teste 1: Investigar a Memória da GPU</h2>
    <canvas id="gpuCanvas1" width="64" height="1" style="border: 1px solid black; margin-bottom: 10px;"></canvas>
    <pre id="gpuResult1"></pre>
    <button onclick="testGPUMemory1()">Teste GPU 1: Padrão Linear Horizontal</button>

    <canvas id="gpuCanvas2" width="1" height="64" style="border: 1px solid black; margin-bottom: 10px;"></canvas>
    <pre id="gpuResult2"></pre>
    <button onclick="testGPUMemory2()">Teste GPU 2: Padrão Linear Vertical</button>

    <canvas id="gpuCanvas3" width="8" height="8" style="border: 1px solid black; margin-bottom: 10px;"></canvas>
    <pre id="gpuResult3"></pre>
    <button onclick="testGPUMemory3()">Teste GPU 3: Padrão de Xadrez</button>

    <canvas id="gpuCanvas4" width="16" height="16" style="border: 1px solid black; margin-bottom: 10px;"></canvas>
    <pre id="gpuResult4"></pre>
    <button onclick="testGPUMemory4()">Teste GPU 4: Leitura Amostrada</button>

    <hr>

    <h2>Teste 2: Buscar Objetos de Interesse no Escopo Global</h2>
    <pre id="globalResult1"></pre>
    <button onclick="testGlobalScope1()">Teste Global 1: Listar Propriedades</button>

    <pre id="globalResult2"></pre>
    <button onclick="testGlobalScope2()">Teste Global 2: Inspeção Seletiva</button>

    <pre id="globalResult3"></pre>
    <button onclick="testGlobalScope3()">Teste Global 3: Buscar por Nomes</button>

    <pre id="globalResult4"></pre>
    <button onclick="testGlobalScope4()">Teste Global 4: Tentar Acessar Funções</button>

    <hr>

    <h2>Teste 3: Desenvolver Primitivas de Leitura/Escrita Mais Sofisticadas</h2>
    <canvas id="primitiveCanvas1" width="4" height="1" style="border: 1px solid black; margin-bottom: 10px;"></canvas>
    <pre id="primitiveResult1"></pre>
    <button onclick="testPrimitives1()">Teste Primitiva 1: Escrita Controlada (RGBA)</button>

    <canvas id="primitiveCanvas2" width="1" height="4" style="border: 1px solid black; margin-bottom: 10px;"></canvas>
    <pre id="primitiveResult2"></pre>
    <button onclick="testPrimitives2()">Teste Primitiva 2: Leitura Seletiva (Canal)</button>

    <canvas id="primitiveCanvas3" width="2" height="2" style="border: 1px solid black; margin-bottom: 10px;"></canvas>
    <pre id="primitiveResult3"></pre>
    <button onclick="testPrimitives3()">Teste Primitiva 3: Deslocamento de Dados</button>

    <canvas id="primitiveCanvas4" width="2" height="2" style="border: 1px solid black; margin-bottom: 10px;"></canvas>
    <pre id="primitiveResult4"></pre>
    <button onclick="testPrimitives4()">Teste Primitiva 4: Leitura Indireta (Offset)</button>

    <hr>

    <h2>Teste 4: Analisar a Disposição da Memória</h2>
    <pre id="memoryLayoutResult1"></pre>
    <button onclick="testMemoryLayout1()">Teste Layout 1: Alocar e Ler (Sequencial)</button>

    <pre id="memoryLayoutResult2"></pre>
    <button onclick="testMemoryLayout2()">Teste Layout 2: Alocar e Ler (Espaçado)</button>

    <pre id="memoryLayoutResult3"></pre>
    <button onclick="testMemoryLayout3()">Teste Layout 3: Inspeção de Buffers Globais</button>

    <pre id="memoryLayoutResult4"></pre>
    <button onclick="testMemoryLayout4()">Teste Layout 4: Tentativa de Overlap</button>

    <hr>

    <script>
        const log = (message, type = 'info') => {
            const outputDiv = document.getElementById('output');
            if (outputDiv) {
                outputDiv.innerHTML += `<span style="color: <span class="math-inline">\{type \=\=\= 'error' ? 'red' \: type \=\=\= 'warning' ? 'orange' \: 'blue'\};"\></span>{new Date().toLocaleTimeString()} - ${message}\n</span>`;
            } else {
                console.error('Elemento #output não encontrado!');
            }
        };

        function prepareData() {
            log("Função prepareData() iniciada e concluída (para consistência).", 'info');
            let bufferSize = 64;
            let buffer = new ArrayBuffer(bufferSize);
            let view = new Uint8Array(buffer);
            return { buffer, view, bufferSize };
        }

        // --- Teste 1: Investigar a Memória da GPU ---
        function testGPUMemory1() {
            const canvas = document.getElementById('gpuCanvas1');
            const ctx = canvas.getContext('2d');
            const resultElement = document.getElementById('gpuResult1');
            if (ctx) {
                for (let i = 0; i < canvas.width; i++) {
                    ctx.fillStyle = `rgba(${i * 4 % 256}, ${(i * 4 + 85) % 256}, ${(i * 4 + 170) % 256}, 255)`;
                    ctx.fillRect(i, 0, 1, 1);
                }
                const imageData = ctx.getImageData(0, 0, canvas.width, 1).data;
                resultElement.textContent = 'Padrão Horizontal RGBA: ' + Array.from(imageData).join(',');
            } else {
                resultElement.textContent = 'Erro ao obter contexto GPU 1.';
            }
        }

        function testGPUMemory2() {
            const canvas = document.getElementById('gpuCanvas2');
            const ctx = canvas.getContext('2d');
            const resultElement = document.getElementById('gpuResult2');
            if (ctx) {
                for (let i = 0; i < canvas.height; i++) {
                    ctx.fillStyle = `rgba(${(i * 4 + 170) % 256}, ${i * 4 % 256}, ${(i * 4 + 85) % 256}, 255)`;
                    ctx.fillRect(0, i, 1, 1);
                }
                const imageData = ctx.getImageData(0, 0, 1, canvas.height).data;
                resultElement.textContent = 'Padrão Vertical RGBA: ' + Array.from(imageData).join(',');
            } else {
                resultElement.textContent = 'Erro ao obter contexto GPU 2.';
            }
        }

        function testGPUMemory3() {
            const canvas = document.getElementById('gpuCanvas3');
            const ctx = canvas.getContext('2d');
            const resultElement = document.getElementById('gpuResult3');
            if (ctx) {
                for (let y = 0; y < canvas.height; y++) {
                    for (let x = 0; x < canvas.width; x++) {
                        ctx.fillStyle = (x % 2 === y % 2) ? 'black' : 'white';
                        ctx.fillRect(x, y, 1, 1);
                    }
                }
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                resultElement.textContent = 'Padrão Xadrez RGBA: ' + Array.from(imageData).join(',');
            } else {
                resultElement.textContent = 'Erro ao obter contexto GPU 3.';
            }
        }

        function testGPUMemory4() {
            const canvas = document.getElementById('gpuCanvas4');
            const ctx = canvas.getContext('2d');
            const resultElement = document.getElementById('gpuResult4');
            if (ctx) {
                ctx.fillStyle = 'red';
                ctx.fillRect(0, 0, 8, 8);
                ctx.fillStyle = 'blue';
                ctx.fillRect(8, 8, 8, 8);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                // Tentativa de ler alguns pixels espaçados
                const sampledData = [
                    imageData[0], imageData[1], imageData[2], imageData[3], // (0,0) Red
                    imageData[4 * 8 * 4 + 0], imageData[4 * 8 * 4 + 1], imageData[4 * 8 * 4 + 2], imageData[4 * 8 * 4 + 3], // (8,0) ?
                    imageData[8 * 8 * 4 + 0], imageData[8 * 8 * 4 + 1], imageData[8 * 8 * 4 + 2], imageData[8 * 8 * 4 + 3], // (0,8) ?
                    imageData[12 * 12 * 4 + 0], imageData[12 * 12 * 4 + 1], imageData[12 * 12 * 4 + 2], imageData[12 * 12 * 4 + 3]  // (12,12) Blue
                ];
                resultElement.textContent = 'Leitura Amostrada RGBA: ' + sampledData.join(',');
            } else {
                resultElement.textContent = 'Erro ao obter contexto GPU 4.';
            }
        }

        // --- Teste 2: Buscar Objetos de Interesse no Escopo Global ---
        function testGlobalScope1() {
            const resultElement = document.getElementById('globalResult1');
            let globalProperties = [];
            for (let prop in window) {
                globalProperties.push(prop);
            }
            resultElement.textContent = 'Propriedades Globais: ' + globalProperties.join(', ');
        }

        function testGlobalScope2() {
            const resultElement = document.getElementById('globalResult2');
            let interestingObjects = ['document', 'window', 'console', 'WebGLRenderingContext'];
            let inspectionResults = [];
            for (let objName of interestingObjects) {
                try {
                    let obj = window[objName];
                    if (obj) {
                        inspectionResults.push(`${objName}: ${typeof obj}`);
                    } else {
                        inspectionResults.push(`${objName}: Não encontrado`);
                    }
                } catch (e) {
                    inspectionResults.push(`${objName}: Erro ao inspecionar: ${e}`);
                }
            }
            resultElement.textContent = 'Inspeção Seletiva: ' + inspectionResults.join(', ');
        }

        function testGlobalScope3() {
            const resultElement = document.getElementById('globalResult3');
            let searchTerms = ['memory', 'buffer', 'array', 'webgl'];
            let foundNames = [];
            for (let prop in window) {
                for (let term of searchTerms) {
                    if (prop.toLowerCase().includes(term)) {
                        foundNames.push(prop);
                        break;
                    }
                }
            }
            resultElement.textContent = 'Nomes Globais Encontrados: ' + foundNames.join(', ');
        }

        function testGlobalScope4() {
            const resultElement = document.getElementById('globalResult4');
            let functionNames = ['alert', 'eval', 'setTimeout', 'requestAnimationFrame'];
            let functionTypes = [];
            for (let funcName of functionNames) {
                try {
                    let func = window[funcName];
                    if (typeof func === 'function') {
                        functionTypes.push(`${funcName}: function`);
                    } else {
                        functionTypes.push(`${funcName}: not function or not found`);
                    }
                } catch (e) {
                    functionTypes.push(`${funcName}: Error: ${e}`);
                }
            }
            resultElement.textContent = 'Tipos de Funções Globais: ' + functionTypes.join(', ');
        }

        // --- Teste 3: Desenvolver Primitivas de Leitura/Escrita Mais Sofisticadas ---
        function testPrimitives1() {
            const canvas = document.getElementById('primitiveCanvas1');
            const ctx = canvas.getContext('2d');
            const resultElement = document.getElementById('primitiveResult1');
            if (ctx) {
                // Escrevendo RGBA diretamente
                let data = new Uint8ClampedArray([
                    255, 0, 0, 255, // Vermelho
                    0, 255, 0, 255, // Verde
                    0, 0, 255, 255, // Azul
                    255, 255, 0, 255  // Amarelo
                ]);
                let imageData = new ImageData(data, canvas.width, canvas.height);
                ctx.putImageData(imageData, 0, 0);
                resultElement.textContent = 'Escrita RGBA: ' + Array.from(data).join(',');
            } else {
                resultElement.textContent = 'Erro Primitive 1.';
            }
        }

        function testPrimitives2() {
            const canvas = document.getElementById('primitiveCanvas2');
            const ctx = canvas.getContext('2d');
            const resultElement = document.getElementById('primitiveResult2');
            if (ctx) {
                // Lendo apenas o canal vermelho de cada pixel
                ctx.fillStyle = 'red';
                ctx.fillRect(0, 0, 1, 1);
                ctx.fillStyle = 'green';
                ctx.fillRect(0, 1, 1, 1);
                ctx.fillStyle = 'blue';
                ctx.fillRect(0, 2, 1, 1);
                ctx.fillStyle = 'yellow';
                ctx.fillRect(0, 3, 1, 1);

                const imageData = ctx.getImageData(0, 0, 1, canvas.height).data;
                let redChannels = [];
                for (let i = 0; i < imageData.length; i += 4) {
                    redChannels.push(imageData[i]);
                }
                resultElement.textContent = 'Canal Vermelho: ' + redChannels.join(',');
            } else {
                resultElement.textContent = 'Erro Primitive 2.';
            }
        }

        function testPrimitives3() {
            const canvas = document.getElementById('primitiveCanvas3');
            const ctx = canvas.getContext('2d');
            const resultElement = document.getElementById('primitiveResult3');
            if (ctx) {
                // Deslocando dados dentro do canvas
                ctx.fillStyle = 'purple';
                ctx.fillRect(0, 0, 2, 2);
                let originalData = ctx.getImageData(0, 0, 2, 2).data;

                // Deslocando um pixel para a direita
                ctx.clearRect(0, 0, 2, 2);
                ctx.putImageData(new ImageData(new Uint8ClampedArray([
                    0, 0, 0, 0, originalData[0], originalData[1], originalData[2], originalData[3],
                    0, 0, 0, 0, originalData[4], originalData[5], originalData[6], originalData[7]
                ]), 2, 2), 0, 0);

                let displacedData = ctx.getImageData(0, 0, 2, 2).data;
                resultElement.textContent = 'Deslocamento: Original: ' + Array.from(originalData).join(',') + ' Deslocado: ' + Array.from(displacedData).join(',');
            } else {
                resultElement.textContent = 'Erro Primitive 3.';
            }
        }

        function testPrimitives4() {
            const canvas = document.getElementById('primitiveCanvas4');
            const ctx = canvas.getContext('2d');
            const resultElement = document.getElementById('primitiveResult4');
            if (ctx) {
                // Tentando ler dados com um offset
                ctx.fillStyle = 'orange';
                ctx.fillRect(0, 0, 1, 1);
                ctx.fillStyle = 'cyan';
                ctx.fillRect(1, 1, 1, 1);

                let imageData = ctx.getImageData(0, 0
