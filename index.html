<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PoC v20 - Base + Fase 2 (Catch Interno F1)</title>
    <style>/* ... Estilos ... */</style>
</head>
<body>
    <h1>PoC v20 - Base + Fase 2 (Catch Interno F1)</h1>
    <button id="runBtn" onclick="runEverythingInSequence_v20()">Iniciar Teste Completo</button>
    <div id="output"></div>
    <div id="xss-target-div">Área para teste de XSS DOM.</div>

    <script>
        // --- Globals, Log, Helpers ---
        // ... (Globals e Helpers como na v19) ...
        const log = (message, type = 'info') => { /* ... */ };
        const toHex = (val, bits = 32) => { /* ... */ };
        const isPotentialPointer64 = (high, low) => { /* ... */ };
        const isPotentialData32 = (val) => { /* ... */ };

        // ============================================================
        // --- FASE 1: Código Original com Tratamento de Erro INTERNO ---
        // ============================================================
        log("Definindo Funções Originais da Fase 1 (com try/catch interno)", "info");

        // Funções originais T1, T2, T3, T4 (mantendo alerts em T1)
        const testCSPBypass = async () => { /* ... (Código T1 Original) ... */ };
        const testOOBReadInfoLeakEnhancedStore = async () => { /* ... (Código T2 Original) ... */ return true; };
        const testBasicPP = async () => { /* ... (Código T3 Original) ... */ return true; }; // Assume return success aqui
        const testPPJsonHijack = async () => { /* ... (Código T4 Original) ... */ return true; }; // Assume return success aqui

        // --- Função Principal Original (`runAllTests`) COM TRY/CATCH INTERNO ---
        const runAllTests = async () => {
            // if (runBtn) runBtn.disabled = true; // Removido daqui para runner principal
            log("==== [F1 Orig] INICIANDO PoC Original v9 (runAllTests com Catch Interno) ====", 'critical');

            try {
                log("[F1] Iniciando T1: XSS...", 'info');
                await testCSPBypass(); // Teste 1 Original
                log("[F1] T1: XSS Concluído (aparentemente).", 'info');
            } catch (e) { log(`[F1] ERRO DURANTE Teste 1 (XSS): ${e.message}`, 'error'); }

            await new Promise(resolve => setTimeout(resolve, MEDIUM_PAUSE));

            try {
                log("[F1] Iniciando T2: OOB...", 'info');
                await testOOBReadInfoLeakEnhancedStore(); // Teste 2 Original
                log("[F1] T2: OOB Concluído (aparentemente).", 'info');
            } catch (e) { log(`[F1] ERRO DURANTE Teste 2 (OOB): ${e.message}`, 'error'); }

            await new Promise(resolve => setTimeout(resolve, MEDIUM_PAUSE));

            try {
                log("[F1] Iniciando T3: PP Basic...", 'info');
                await testBasicPP(); // Teste 3 Original
                log("[F1] T3: PP Basic Concluído (aparentemente).", 'info');
            } catch (e) { log(`[F1] ERRO DURANTE Teste 3 (PP Basic): ${e.message}`, 'error'); }

            await new Promise(resolve => setTimeout(resolve, MEDIUM_PAUSE));

            try {
                log("[F1] Iniciando T4: PP Hijack...", 'info');
                await testPPJsonHijack(); // Teste 4 Original
                log("[F1] T4: PP Hijack Concluído (aparentemente).", 'info');
            } catch (e) { log(`[F1] ERRO DURANTE Teste 4 (PP Hijack): ${e.message}`, 'error'); }

            await new Promise(resolve => setTimeout(resolve, MEDIUM_PAUSE));
            log("\n==== [F1 Orig] PoC Original v9 FINALIZADO (runAllTests com Catch Interno) ====", 'critical');
            log(`==== [F1 Orig] Estado Pós-Fase 1: xssFlag=${xssRanFlag}, OOB=${leakedValueFromOOB?'Stored':'null'} ====`,'info');
            // A função runAllTests original não retornava valor, mantemos assim.
        };

        // --- FIM DO CÓDIGO ORIGINAL AJUSTADO ---


        // ==========================================================
        // --- FASE 2: Testes Adicionais Isolados ---
        // ==========================================================
        log("Definindo Testes da Fase 2 (Verificações Isoladas)", "info");
        // Definições dos testes phase2_... (A, B, C, D/E, F, J, K) como na v19
        const phase2_VerifyXSSDOMModification = async () => { /* ... */ log("--- [Fase 2] A: Concluído ---", 'test');};
        const phase2_VerifyBasicPPSuccess = async () => { /* ... */ log("--- [Fase 2] B: Concluído ---", 'test');};
        const phase2_VerifyPPHijack = async () => { /* ... */ log("--- [Fase 2] C: Concluído ---", 'test');};
        const phase2_TestAdvancedPPVectors = async () => { /* ... */ log("--- [Fase 2] D: Concluído ---", 'test');};
        const phase2_TestCanvasFunctionality = async () => { /* ... */ log("--- [Fase 2] E: Concluído ---", 'test');};
        // Adicionar outros testes da Fase 2 que estavam faltando na v19 (ex: Erros, Coleta Dados)
        const phase2_BasicDataCollection = async () => { log("--- [Fase 2] Coleta Dados Iniciando ---", 'test'); /* ... */ log("--- [Fase 2] Coleta Dados Concluído ---", 'test'); };
        const phase2_EnvironmentProbing = async () => { log("--- [Fase 2] Sondagem Ambiente Iniciando ---", 'test'); /* ... */ log("--- [Fase 2] Sondagem Ambiente Concluído ---", 'test'); };
        const phase2_ErrorObservation = async () => { log("--- [Fase 2] Observação Erros Iniciando ---", 'test'); /* ... */ log("--- [Fase 2] Observação Erros Concluído ---", 'test'); };


        // Função para rodar a Fase 2 Isolada (agora inclui todos os testes relevantes)
        const runPhase2_IsolatedTests = async () => {
            log("==== [Fase 2] INICIANDO Verificações Isoladas ====", 'critical');
            await phase2_BasicDataCollection(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE));
            await phase2_EnvironmentProbing(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE));
            await phase2_VerifyXSSDOMModification(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE)); // A (Verif XSS)
            await phase2_VerifyBasicPPSuccess(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE)); // B (Verif PP Basica)
            await phase2_VerifyPPHijack(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE)); // C (Verif PP Hijack)
            await phase2_TestAdvancedPPVectors(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE)); // D (PP Avançada)
            await phase2_TestCanvasFunctionality(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE)); // E (Canvas)
            await phase2_ErrorObservation(); await new Promise(r=>setTimeout(r,MEDIUM_PAUSE)); // F (Erros)
            // Testes J e K (PP Avançada/Gadgets) foram incorporados em D, renomear se necessário ou adicionar aqui
            log("==== [Fase 2] Verificações Isoladas CONCLUÍDAS ====", 'critical');
        }


        // --- Função Principal Nova ---
        const runEverythingInSequence_v20 = async () => { // Chamada pelo botão
            if (runBtn) runBtn.disabled = true;
            log("==== INICIANDO PoC Final v20 (Base com Catch Interno + Fase 2) ====", 'critical');

            log(">>> Iniciando Fase 1 (Execução 'runAllTests' com Catch Interno) <<<", 'warn');
            // Chama a função original modificada (com try/catch interno). Não usamos await aqui.
            runAllTests();
            log(">>> Fase 1 ('runAllTests') INICIADA. Aguardando tempo fixo... <<<", 'warn');

            log(`\n>>> PAUSA LONGA ANTES DA FASE 2 (${LONG_PAUSE/1000} segundos) <<<\n`, "warn");
            await new Promise(r => setTimeout(r, LONG_PAUSE));

            log(">>> Iniciando Fase 2 (Testes Adicionais Isolados) <<<", 'warn');
            await runPhase2_IsolatedTests();
            log(">>> Fase 2 (Verificações Isoladas) CONCLUÍDA <<<", 'warn');

            log("\n==== PoC Final v20 CONCLUÍDA ====", 'critical');
            // Sem resumo final
            log("Listeners podem continuar ativos.", "warn");
            if (runBtn) runBtn.disabled = false;
        };

        // Limpeza listeners
        window.addEventListener('unload', () => { /* ... */ });
        // Botão agora chama runEverythingInSequence_v20
        // document.addEventListener('DOMContentLoaded', runEverythingInSequence_v20);

    </script>

</body>
</html>
