<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit Exploit - Teste Memory Layout (Isolado)</title>
</head>

<body>
    <h1>Teste Memory Layout (Isolado)</h1>
    <div id="output"></div>

    <h2>Teste 4: Analisar a Disposição da Memória</h2>
    <pre id="memoryLayoutResult1"></pre>
    <button id="memoryLayoutButton1">Teste Layout 1: Alocar e Ler (Sequencial)</button>

    <pre id="memoryLayoutResult2"></pre>
    <button id="memoryLayoutButton2">Teste Layout 2: Alocar e Ler (Espaçado)</button>

    <pre id="memoryLayoutResult3"></pre>
    <button id="memoryLayoutButton3">Teste Layout 3: Inspeção de Buffers Globais</button>

    <pre id="memoryLayoutResult4"></pre>
    <button id="memoryLayoutButton4">Teste Layout 4: Tentativa de Overlap</button>

    <script>
        const log = (message, type = 'info') => {
            const outputDiv = document.getElementById('output');
            if (outputDiv) {
                outputDiv.innerHTML += `<span style="color: ${type === 'error' ? 'red' : type === 'warning' ? 'orange' : 'blue'};">${new Date().toLocaleTimeString()} - ${message}\n</span>`;
            } else {
                console.error('Elemento #output não encontrado!');
            }
        };

        function prepareData() {
            log("Função prepareData() iniciada e concluída (para consistência).", 'info');
            let bufferSize = 64;
            let buffer = new ArrayBuffer(bufferSize);
            let view = new Uint8Array(buffer);
            return {
                buffer,
                view,
                bufferSize
            };
        }

        // --- Teste 4: Analisar a Disposição da Memória ---
        function testMemoryLayout1() {
            log("\n--- Teste 4: Analisar a Disposição da Memória ---", 'critical');
            prepareData();
            const resultElement = document.getElementById('memoryLayoutResult1');
            try {
                const buffer1 = new ArrayBuffer(32);
                const view1 = new Uint8Array(buffer1);
                for (let i = 0; i < view1.length; i++) {
                    view1[i] = i;
                }
                let readValues = [];
                for (let i = 0; i < view1.length; i++) {
                    readValues.push(view1[i]);
                }
                resultElement.textContent = 'Leitura Sequencial: ' + readValues.join(',');
            } catch (e) {
                resultElement.textContent = 'Erro Layout 1: ' + e;
            }
        }

        function testMemoryLayout2() {
            log("\n--- Teste 4: Analisar a Disposição da Memória ---", 'critical');
            prepareData();
            const resultElement = document.getElementById('memoryLayoutResult2');
            try {
                const buffer2 = new ArrayBuffer(64);
                const view2 = new Uint32Array(buffer2);
                for (let i = 0; i < view2.length; i++) {
                    view2[i] = i * 4;
                }
                let readValues = [];
                for (let i = 0; i < view2.length; i++) {
                    readValues.push(view2[i]);
                }
                resultElement.textContent = 'Leitura Espaçada (Uint32): ' + readValues.join(',');
            } catch (e) {
                resultElement.textContent = 'Erro Layout 2: ' + e;
            }
        }

        function testMemoryLayout3() {
            log("\n--- Teste 4: Analisar a Disposição da Memória ---", 'critical');
            prepareData();
            const resultElement = document.getElementById('memoryLayoutResult3');
            let bufferInfo = [];
            for (let prop in window) {
                try {
                    if (window[prop] instanceof ArrayBuffer) {
                        bufferInfo.push(`${prop}: Size ${window[prop].byteLength}`);
                    }
                } catch (e) {
                    // Ignorar erros ao acessar propriedades
                }
            }
            resultElement.textContent = 'Buffers Globais: ' + bufferInfo.join('; ');
        }

        function testMemoryLayout4() {
            log("\n--- Teste 4: Analisar a Disposição da Memória ---", 'critical');
            prepareData();
            const resultElement = document.getElementById('memoryLayoutResult4');
            try {
                const buffer3 = new ArrayBuffer(32);
                const view3 = new Uint8Array(buffer3);
                const buffer4 = new ArrayBuffer(32);
                const view4 = new Uint8Array(buffer4);

                for (let i = 0; i < view3.length; i++) {
                    view3[i] = i * 2;
                }

                // Tentativa de acessar memória fora dos limites (pode gerar erro ou comportamento indefinido)
                let overlapAttempt = view3[30] + view4[2];
                resultElement.textContent = 'Tentativa de Overlap: ' + overlapAttempt;

            } catch (e) {
                resultElement.textContent = 'Erro Overlap: ' + e;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('memoryLayoutButton1').addEventListener('click', testMemoryLayout1);
            document.getElementById('memoryLayoutButton2').addEventListener('click', testMemoryLayout2);
            document.getElementById('memoryLayoutButton3').addEventListener('click', testMemoryLayout3);
            document.getElementById('memoryLayoutButton4').addEventListener('click', testMemoryLayout4);
        });
    </script>
</body>

</html>
