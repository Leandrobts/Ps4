<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit Exploit - Testes de Bypass CSP</title>
    <style>
        body { background-color: lightblue; }
    </style>
    </head>
<body>
    <h1>Testes de Bypass CSP</h1>
    <div id="output"></div>
    <iframe id="cspFrame" sandbox="allow-scripts"></iframe>
    <script>
        const log = (message, type = 'info') => {
            const outputDiv = document.getElementById('output');
            if (outputDiv) {
                outputDiv.innerHTML += `<span style="color: ${type === 'error' ? 'red' : type === 'warning' ? 'orange' : 'blue'};">${new Date().toLocaleTimeString()} - ${message}\n</span>`;
            } else {
                console.error('Elemento #output não encontrado!');
            }
        };

        function prepareData() {
            log("Função prepareData() iniciada.", 'warning');
            let bufferSize = 64;
            let buffer = new ArrayBuffer(bufferSize);
            let view = new Uint8Array(buffer);
            log("Função prepareData() concluída.", 'success');
            return { buffer, view, bufferSize };
        }

        function testCSPBypassAttempts() {
            log("\n--- Testando Possíveis Bypasses de CSP ---", 'critical');
            try {
                // 1. Tentativa com 'onclick' (sabemos que provavelmente falha)
                const inlineEventHandlerClick = document.createElement('div');
                inlineEventHandlerClick.setAttribute('onclick', 'alert("CSP Bypass? - Onclick")');
                inlineEventHandlerClick.textContent = 'Clique para testar CSP (Onclick)';
                document.body.appendChild(inlineEventHandlerClick);
                log("Teste CSP: Elemento com event handler 'onclick' injetado.");

                // 2. Tentativa com 'onmouseover'
                const inlineEventHandlerMouseover = document.createElement('div');
                inlineEventHandlerMouseover.setAttribute('onmouseover', 'alert("CSP Bypass? - Onmouseover")');
                inlineEventHandlerMouseover.textContent = 'Passe o mouse para testar CSP (Onmouseover)';
                document.body.appendChild(inlineEventHandlerMouseover);
                log("Teste CSP: Elemento com event handler 'onmouseover' injetado.");

                // 3. Tentativa de injetar <script> com src (pode ser bloqueado se a fonte não estiver na whitelist)
                const externalScript = document.createElement('script');
                externalScript.src = 'data:text/javascript,console.log("External script test");'; // Usando data URI para teste
                document.body.appendChild(externalScript);
                log("Teste CSP: Tag <script> com src (data URI) injetada.");

                // 4. Tentativa de manipular o 'sandbox' do iframe (enviando e recebendo mensagens)
                const cspFrame = document.getElementById('cspFrame');
                if (cspFrame) {
                    const message = { type: 'testCSP', data: 'hello from main window' };
                    cspFrame.contentWindow.postMessage(JSON.stringify(message), '*');
                    window.addEventListener('message', (event) => {
                        try {
                            const received = JSON.parse(event.data);
                            log(`Teste CSP (iframe): Mensagem recebida: ${JSON.stringify(received)}`);
                        } catch (e) {
                            log(`Teste CSP (iframe): Mensagem recebida (não JSON): ${event.data}`);
                        }
                    });
                    log("Teste CSP (iframe): Mensagem postada para iframe.");

                    // Tentativa de injetar script dentro do iframe (pode ser permitido pelo 'sandbox')
                    try {
                        const iframeDoc = cspFrame.contentDocument || cspFrame.contentWindow.document;
                        const scriptInIframe = iframeDoc.createElement('script');
                        scriptInIframe.textContent = 'console.log("Script dentro do iframe"); parent.postMessage({ type: "iframeReply", data: "iframe says hello" }, "*");';
                        iframeDoc.head.appendChild(scriptInIframe);
                        log("Teste CSP (iframe): Tentativa de injetar script dentro do iframe.");
                    } catch (e) {
                        log(`Erro ao injetar script no iframe: ${e}`, 'warning');
                    }
                }

            } catch (error) {
                log(`Erro durante os testes de CSP: ${error}`, 'error');
            }
        }

        function mainExploit() {
            log("mainExploit() iniciado.", 'critical');
            prepareData(); // Chamando a função prepareData CORRETA
            testCSPBypassAttempts();
            log("mainExploit() concluído.", 'critical');
        }

        mainExploit();
    </script>
</body>
</html>
