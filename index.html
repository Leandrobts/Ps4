<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit Advanced OOB Write POC (v12.00)</title>
    <style>
        body { font-family: monospace; }
        #output { white-space: pre-wrap; }
        .error { color: red; }
        .warning { color: orange; }
        .success { color: green; }
        .info { color: blue; }
        .critical { color: magenta; font-weight: bold; }
    </style>
</head>
<body>
    <h1>PS4 WebKit Advanced OOB Write POC (v12.00)</h1>
    <div id="output"></div>

    <script>
        async function advancedOOBWriteTest() {
            const outputDiv = document.getElementById('output');
            const log = (message, type = 'info') => {
                outputDiv.innerHTML += `<span class="${type}">${new Date().toLocaleTimeString()} - ${message}\n</span>`;
            };

            log("Iniciando Teste Avançado de OOB Write...", 'critical');

            const bufferSize = 128;
            const buffer = new ArrayBuffer(bufferSize);
            const view = new Uint8Array(buffer);
            const writeValue = 0xAA;

            const offsetsToWrite = [-64, -1, 0, bufferSize - 1, bufferSize, bufferSize + 64, bufferSize * 2];
            const offsetsToRead = [-32, 0, 32, bufferSize - 1, bufferSize, bufferSize + 32, bufferSize * 2 - 1];

            log(`ArrayBuffer criado com tamanho: ${bufferSize}`, 'info');
            log(`Valor de escrita: 0x${writeValue.toString(16)}`, 'info');
            log(`Offsets de escrita a serem testados: ${offsetsToWrite.join(', ')}`, 'info');
            log(`Offsets de leitura a serem testados após cada escrita: ${offsetsToRead.join(', ')}`, 'info');

            for (const writeOffset of offsetsToWrite) {
                log(`\nTentando escrever 0x${writeValue.toString(16)} no offset: ${writeOffset}`, 'warning');
                try {
                    view[writeOffset] = writeValue;
                    log(`Escrita no offset ${writeOffset} aparentemente bem-sucedida (sem erro imediato).`, 'success');

                    for (const readOffset of offsetsToRead) {
                        try {
                            const readValue = view[readOffset];
                            log(`  Leitura no offset ${readOffset}: 0x${readValue.toString(16)} após escrita no offset ${writeOffset}.`, 'info');
                            if (readOffset >= 0 && readOffset < bufferSize && readValue === writeValue && writeOffset >= bufferSize) {
                                log(`  <span class="critical">POSSÍVEL CORRUPÇÃO DE MEMÓRIA: Escrita fora dos limites (${writeOffset}) afetou leitura dentro dos limites (${readOffset})!</span>`, 'critical');
                            } else if (readOffset >= 0 && readOffset < bufferSize && readValue === writeValue && writeOffset < 0) {
                                log(`  <span class="critical">POSSÍVEL CORRUPÇÃO DE MEMÓRIA (OFFSET NEGATIVO): Escrita fora dos limites (${writeOffset}) afetou leitura dentro dos limites (${readOffset})!</span>`, 'critical');
                            } else if (readOffset !== 0 && writeOffset === 0 && readValue === writeValue) {
                                log(`  <span class="warning">AVISO: Escrita no início do buffer afetou leitura em outro offset (${readOffset}).</span>`, 'warning');
                            }
                        } catch (readError) {
                            log(`  Erro ao ler no offset ${readOffset}: ${readError.message}`, 'error');
                        }
                    }

                } catch (writeError) {
                    log(`Erro ao escrever no offset ${writeOffset}: ${writeError.message}`, 'error');
                }
                await new Promise(resolve => setTimeout(resolve, 1000)); // Pequeno delay entre as tentativas
            }

            log("\nTeste Avançado de OOB Write Concluído.", 'critical');
            log("Analise cuidadosamente a saída para identificar possíveis corrupções de memória.", 'critical');
        }

        document.addEventListener('DOMContentLoaded', advancedOOBWriteTest);
    </script>
</body>
</html>
