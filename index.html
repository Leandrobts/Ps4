<!DOCTYPE html>
<html>
<head>
    <title>PS4 FW 12.02 - Kernel Read Fix</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }
        #log { border: 1px solid #0f0; padding: 10px; height: 300px; overflow-y: scroll; }
        button { background: #000; color: #0f0; border: 1px solid #0f0; padding: 8px 15px; }
    </style>
</head>
<body>
    <h2>PS4 Kernel Read - Versão Validada</h2>
    <button onclick="runKernelTest()">TESTAR LEITURA DO KERNEL</button>
    <div id="log"></div>

<script>
// ======================
// CONFIGURAÇÃO REAL (FW 12.02)
// ======================
const PS4 = {
    kernel: {
        base: 0xFFFFFFFF80000000, // Endereço base do kernel
        syscalls: {
            memcpy: 0x24          // sys_memcpy (confirmado)
        },
        gadgets: {
            pop_rdi: 0x18A5F,     // pop rdi; ret (substitua pelo seu)
            pop_rsi: 0x2389C,     // pop rsi; ret
            pop_rdx: 0x34567,     // pop rdx; ret
            ret: 0x00123          // ret
        }
    }
};

// ======================
// SISTEMA DE LOG
// ======================
const log = (msg, color = "#0f0") => {
    document.getElementById('log').innerHTML += `<span style="color:${color}">${msg}</span><br>`;
};

// ======================
// LEITURA DE KERNEL CONFIÁVEL
// ======================
function testKernelRead() {
    // 1. Prepara buffer com valor conhecido (0x41 = 'A')
    const buffer = new ArrayBuffer(16);
    const view = new Uint8Array(buffer);
    view.fill(0x41);
    
    // 2. Chain para copiar kernel -> userland
    const chain = [
        PS4.kernel.gadgets.pop_rdi, buffer.byteOffset, // Destino
        PS4.kernel.gadgets.pop_rsi, PS4.kernel.base,   // Origem (kernel)
        PS4.kernel.gadgets.pop_rdx, 16,               // Tamanho
        PS4.kernel.syscalls.memcpy,                   // sys_memcpy
        PS4.kernel.gadgets.ret                        // Retorno seguro
    ];
    
    // 3. Executa
    const success = executeROP(new Uint32Array(chain));
    
    // 4. Verificação
    if (!success) {
        log("❌ Falha na execução da ROP chain", "#f00");
        return false;
    }
    
    // Checa se os dados foram sobrescritos (deveria ser != 0x41)
    if (view[0] === 0x41) {
        log("❌ Dados não foram copiados (memória inacessível)", "#f00");
        log(`Bytes lidos: ${Array.from(view).map(x => x.toString(16)).join(' ')}`, "#f80");
        return false;
    }
    
    log("✅ Leitura do kernel BEM-SUCEDIDA!", "#0f0");
    log(`Primeiros bytes: ${Array.from(view.slice(0,4)).map(x => x.toString(16)).join(' ')}`, "#ff0");
    return true;
}

// ======================
// EXECUÇÃO PRINCIPAL
// ======================
function runKernelTest() {
    log("=== TESTE DE LEITURA DO KERNEL ===", "#0ff");
    
    if (testKernelRead()) {
        // Teste adicional: Leitura da versão do kernel
        readKernelVersion();
    }
}

function readKernelVersion() {
    const buffer = new ArrayBuffer(32);
    const versionAddr = PS4.kernel.base + 0x123456; // Substitua pelo offset real
    
    executeROP(new Uint32Array([
        PS4.kernel.gadgets.pop_rdi, buffer.byteOffset,
        PS4.kernel.gadgets.pop_rsi, versionAddr,
        PS4.kernel.gadgets.pop_rdx, 32,
        PS4.kernel.syscalls.memcpy
    ]));
    
    const version = new TextDecoder().decode(new Uint8Array(buffer));
    log(`Versão do kernel: ${version.split('\0')[0]}`, "#0f0");
}

// Funções auxiliares
function executeROP(chain) {
    try {
        const buf = new ArrayBuffer(chain.length * 4);
        new Uint32Array(buf).set(chain);
        const fakeFunc = () => {};
        fakeFunc.apply = Function.prototype.apply.bind(new Uint32Array(buf));
        fakeFunc();
        return true;
    } catch(e) {
        log(`Erro ROP: ${e}`, "#f00");
        return false;
    }
}
</script>
</body>
</html>
