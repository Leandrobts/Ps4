<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PoC - PS4 Extreme Browser Stress Tests</title>
    <style>
        body { font-family: monospace; background: black; color: lime; padding: 20px; }
        #log { white-space: pre-wrap; margin: 20px 0; height: 500px; overflow-y: auto; border: 1px solid lime; padding: 10px; }
        #status { color: red; margin-top: 10px; font-size: 1.2em; }
    </style>
</head>
<body>
<h1>PoC - PS4 Extreme Browser Stress Tests</h1>
<div id="status">Aguardando Testes...</div>
<div id="log"></div>

<script>
// Logger
function log(msg) {
    const logDiv = document.getElementById('log');
    logDiv.textContent += msg + "\n";
    logDiv.scrollTop = logDiv.scrollHeight;
}

// Status display
function updateStatus(msg) {
    document.getElementById('status').textContent = msg;
}

// Delay auxiliar
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Função para rodar um teste com timeout
async function runWithTimeout(fn, name, timeout=5000) {
    updateStatus(`Executando: ${name}...`);
    log(`[*] Running ${name} with timeout ${timeout}ms`);
    let finished = false;
    fn().then(() => finished = true).catch(e => log(`[!!] ${name} error: ${e}`));
    let start = performance.now();
    while (!finished) {
        if (performance.now() - start > timeout) {
            log(`[!!!] ${name} timed out! Aborting test.`);
            updateStatus(`[!!!] ${name} timeout.`);
            return;
        }
        await delay(100);
    }
    log(`[*] ${name} completed.`);
    updateStatus(`[*] ${name} completed.`);
}

// Função para verificar corrupção de memória
function verifyCorruption() {
    const ta = new Float64Array(1);
    ta[0] = 1.234;
    if (!Number.isFinite(ta[0])) log("[CORRUPT] Corrupção de memória detectada!");
    else log("[CLEAN] Nenhuma corrupção detectada.");
}

// Teste 1: JIT Spraying
async function jitSpray() {
    log("[1] JIT Spraying (Type Confusion) started...");
    for (let i = 0; i < 100000; i++) {
        let obj = {};
        obj.prop = 123;
        obj.prop = "abc";
        obj.prop = 456;
    }
    log("[*] JIT Spraying finished.");
    verifyCorruption();
}

// Teste 2: Heap Overflow via DataView (código refinado)
async function heapOverflow() {
    log("[2] Heap Overflow via DataView started...");
    try {
        // Criação de Buffer e DataView
        const buffer = new ArrayBuffer(0x1000000); // 16MB
        const view = new DataView(buffer);
        // Acesso fora dos limites para tentar corromper
        const offset = view.byteLength + 0x100;
        log(`[*] Attempting DataView overflow at offset ${offset}...`);
        view.getUint32(offset); // Deve lançar ou corromper
        log("[!] Unexpected success reading DataView!");
    } catch (e) {
        log(`[OK] DataView exception as expected: ${e}`);
    }
    verifyCorruption();
}

// Teste 3: WebGL Excessive Allocation
async function webGLTest() {
    log("[3] WebGL Excessive Allocation started...");
    try {
        const canvas = document.createElement('canvas');
        // Tenta instanciar tanto WebGL quanto Experimental
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (!gl) {
            log("[!] WebGL not supported.");
            return;
        }
        const buffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
        const size = 10 * 1024 * 1024; // 10MB
        gl.bufferData(gl.ARRAY_BUFFER, size, gl.STATIC_DRAW);
        log(`[!] WebGL bufferData of ${size} bytes completed.`);
    } catch (e) {
        log(`[!!] Exception during WebGL test: ${e}`);
    }
    verifyCorruption();
}

// Orquestrador principal
(async function runAllTests() {
    try {
        log("[+] Starting extreme PS4 browser tests...");
        await runWithTimeout(jitSpray, "JIT Spraying", 5000);
        await runWithTimeout(heapOverflow, "Heap Overflow", 5000);
        await runWithTimeout(webGLTest, "WebGL Excessive Allocation", 5000);
        log("[+] All tests executed.");
        updateStatus("[+] Tests complete.");
    } catch (fatal) {
        log(`[FATAL] Uncaught exception: ${fatal}`);
        updateStatus("[FATAL] Execution stopped.");
    }
})();
</script>
</body>
</html>
